{% extends "base.html" %}

{% block title %}New Component{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Add New Component</h1>
    <a href="{{ url_for('main.index') }}" class="btn btn-secondary">Back to List</a>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0">Component Information</h5>
    </div>
    <div class="card-body">
        <form method="POST" enctype="multipart/form-data" id="componentForm">
            <!-- Basic Information -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="product_number" class="form-label">Product Number *</label>
                        <input type="text" class="form-control" id="product_number" name="product_number" required>
                        <div class="form-text">e.g., F-WL001 for Fabrics, S-WL0001 for Shapes</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="component_type_id" class="form-label">Component Type *</label>
                        <select class="form-select" id="component_type_id" name="component_type_id" required>
                            <option value="">Select Component Type</option>
                            {% for component_type in component_types %}
                                <option value="{{ component_type.id }}">{{ component_type.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="supplier_id" class="form-label">Supplier *</label>
                        <select class="form-select" id="supplier_id" name="supplier_id" required>
                            <option value="">Select Supplier</option>
                            {% for supplier in suppliers %}
                                <option value="{{ supplier.id }}">{{ supplier.supplier_code }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="category_id" class="form-label">Category *</label>
                        <select class="form-select" id="category_id" name="category_id" required>
                            <option value="">Select Category</option>
                            {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="keywords" class="form-label">Keywords *</label>
                        <input type="text" class="form-control" id="keywords" name="keywords" required>
                        <div class="form-text">Comma-separated keywords (e.g., shiny, polyester, jacket, outerwear)</div>
                    </div>
                </div>
            </div>

            <!-- NEW: Brand Selection Section -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card bg-light">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-tag me-2"></i>
                                Brand Association
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="brands" class="form-label">Select Brands</label>
                                <select class="form-select" id="brands" name="brands" multiple size="5">
                                    {% for brand in brands %}
                                        <option value="{{ brand.id }}">{{ brand.name }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">
                                    Hold Ctrl/Cmd to select multiple brands. You can associate this component with multiple brands.
                                </div>
                            </div>

                            <!-- Brand Preview -->
                            <div id="selectedBrandsPreview" class="mt-3" style="display: none;">
                                <label class="form-label">Selected Brands:</label>
                                <div id="brandTags" class="d-flex flex-wrap gap-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <label for="description" class="form-label">Description</label>
                <textarea class="form-control" id="description" name="description" rows="3"></textarea>
            </div>

            <hr>

            <!-- Dynamic Properties Section -->
            <div id="propertiesSection">
                <h5 class="mb-3">Type-Specific Properties</h5>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    Select a component type above to see available properties
                </div>
            </div>

            <hr>

            <!-- Pictures -->
            <h5 class="mb-3">Pictures (up to 5)</h5>

            {% for i in range(1, 6) %}
                <div class="card mb-3 picture-card">
                    <div class="card-header">
                        <h6 class="mb-0">Picture {{ i }}</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="picture_{{ i }}" class="form-label">Image File</label>
                                    <input type="file" class="form-control" id="picture_{{ i }}" name="picture_{{ i }}" accept="image/*">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="picture_{{ i }}_order" class="form-label">Display Order</label>
                                    <input type="number" class="form-control" id="picture_{{ i }}_order" name="picture_{{ i }}_order" value="{{ i }}" min="1">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}

            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <button type="reset" class="btn btn-outline-secondary">Reset</button>
                <button type="submit" class="btn btn-primary">Save Component</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const componentTypeSelect = document.getElementById('component_type_id');
    const propertiesSection = document.getElementById('propertiesSection');
    const form = document.getElementById('componentForm');
    const brandsSelect = document.getElementById('brands');
    const selectedBrandsPreview = document.getElementById('selectedBrandsPreview');
    const brandTags = document.getElementById('brandTags');

    // Property field configurations (UPDATED: removed 'brand' from type properties since it's now handled separately)
    const typeProperties = {
        'Fabrics': {
            'material': { type: 'select', required: true, options: {{ materials | map(attribute='name') | list | tojson }} },
            'color': { type: 'select', required: false, options: {{ colors | map(attribute='name') | list | tojson }} },
            'gender': { type: 'multiselect', required: false, options: ['ladies', 'men', 'unisex', 'all', 'kids'] },
            'finish': { type: 'text', required: false, placeholder: 'e.g., waterproof, matte' },
            'weight': { type: 'text', required: false, placeholder: 'e.g., 120gsm' }
        },
        'Shapes': {
            'gender': { type: 'multiselect', required: false, options: ['ladies', 'men', 'unisex', 'all', 'kids'] },
            'style': { type: 'multiselect', required: false, options: ['casual', 'formal', 'sport', 'winter', 'summer', 'vintage'] },
            'subbrand': { type: 'multiselect', required: false, options: ['MAR Sport', 'MAR Classic', 'MMC Pro', 'MMC Casual', 'UBL Premium', 'UBL Basic'] },
            'subcategory': { type: 'text', required: false, placeholder: 'e.g., jacket, pants' }
        },
        'Buttons': {
            'material': { type: 'select', required: false, options: {{ materials | map(attribute='name') | list | tojson }} },
            'color': { type: 'select', required: false, options: {{ colors | map(attribute='name') | list | tojson }} },
            'size': { type: 'text', required: false, placeholder: 'e.g., 12mm, 15mm' }
        },
        'Zippers': {
            'material': { type: 'select', required: false, options: {{ materials | map(attribute='name') | list | tojson }} },
            'color': { type: 'select', required: false, options: {{ colors | map(attribute='name') | list | tojson }} },
            'size': { type: 'text', required: false, placeholder: 'e.g., 5mm, 8mm' }
        },
        'Labels': {
            'subbrand': { type: 'multiselect', required: false, options: ['MAR Sport', 'MAR Classic', 'MMC Pro', 'MMC Casual', 'UBL Premium', 'UBL Basic'] },
            'material': { type: 'select', required: false, options: {{ materials | map(attribute='name') | list | tojson }} }
        },
        'Hangtags': {
            'subbrand': { type: 'multiselect', required: false, options: ['MAR Sport', 'MAR Classic', 'MMC Pro', 'MMC Casual', 'UBL Premium', 'UBL Basic'] },
            'material': { type: 'select', required: false, options: {{ materials | map(attribute='name') | list | tojson }} }
        },
        'Packaging': {
            'material': { type: 'select', required: false, options: {{ materials | map(attribute='name') | list | tojson }} }
        }
    };

    // Handle component type change
    componentTypeSelect.addEventListener('change', function() {
        const selectedType = this.options[this.selectedIndex].text;
        updatePropertiesSection(selectedType);
    });

    // NEW: Handle brand selection changes
    brandsSelect.addEventListener('change', function() {
        updateBrandPreview();
    });

    function updatePropertiesSection(componentType) {
        const properties = typeProperties[componentType] || {};
        
        if (Object.keys(properties).length === 0) {
            propertiesSection.innerHTML = `
                <h5 class="mb-3">Type-Specific Properties</h5>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    No additional properties available for ${componentType}
                </div>
            `;
            return;
        }

        let html = '<h5 class="mb-3">Type-Specific Properties</h5><div class="row">';
        
        Object.entries(properties).forEach(([propertyName, config]) => {
            html += `<div class="col-md-6"><div class="mb-3">`;
            html += `<label for="${propertyName}" class="form-label">${capitalizeFirst(propertyName)}${config.required ? ' *' : ''}</label>`;
            
            if (config.type === 'select') {
                html += `<select class="form-select" id="${propertyName}" name="${propertyName}"${config.required ? ' required' : ''}>`;
                html += '<option value="">Select ' + capitalizeFirst(propertyName) + '</option>';
                config.options.forEach(option => {
                    html += `<option value="${option}">${option}</option>`;
                });
                html += '</select>';
            } else if (config.type === 'multiselect') {
                html += `<select class="form-select" id="${propertyName}" name="${propertyName}" multiple>`;
                config.options.forEach(option => {
                    html += `<option value="${option}">${option}</option>`;
                });
                html += '</select>';
                html += `<div class="form-text">Hold Ctrl/Cmd to select multiple options</div>`;
            } else if (config.type === 'text') {
                html += `<input type="text" class="form-control" id="${propertyName}" name="${propertyName}"`;
                if (config.placeholder) html += ` placeholder="${config.placeholder}"`;
                if (config.required) html += ' required';
                html += '>';
            }
            
            html += '</div></div>';
        });
        
        html += '</div>';
        propertiesSection.innerHTML = html;
    }

    // NEW: Update brand preview
    function updateBrandPreview() {
        const selectedOptions = Array.from(brandsSelect.selectedOptions);

        if (selectedOptions.length === 0) {
            selectedBrandsPreview.style.display = 'none';
            return;
        }

        selectedBrandsPreview.style.display = 'block';
        brandTags.innerHTML = '';

        selectedOptions.forEach(option => {
            const tag = document.createElement('span');
            tag.className = 'badge bg-primary';
            tag.textContent = option.text;
            brandTags.appendChild(tag);
        });
    }

    function capitalizeFirst(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
    }

    // Form validation
    form.addEventListener('submit', function(event) {
        const productNumber = document.getElementById('product_number').value;
        const componentType = document.getElementById('component_type_id').value;
        const keywords = document.getElementById('keywords').value;
        
        if (!productNumber || !componentType || !keywords) {
            alert('Please fill in all required fields (Product Number, Component Type, and Keywords)');
            event.preventDefault();
            return;
        }

        // Validate product number format based on component type
        const selectedTypeName = componentTypeSelect.options[componentTypeSelect.selectedIndex].text;
        const expectedPrefix = getTypePrefix(selectedTypeName);
        
        if (expectedPrefix && !productNumber.startsWith(expectedPrefix + '-')) {
            if (!confirm(`Product number should start with "${expectedPrefix}-" for ${selectedTypeName}. Continue anyway?`)) {
                event.preventDefault();
                return;
            }
        }
    });

    function getTypePrefix(typeName) {
        const prefixes = {
            'Fabrics': 'F',
            'Shapes': 'S',
            'Buttons': 'B',
            'Zippers': 'Z',
            'Labels': 'L',
            'Hangtags': 'H',
            'Packaging': 'P'
        };
        return prefixes[typeName];
    }

    // Reset form handling
    document.querySelector('button[type="reset"]').addEventListener('click', function() {
        setTimeout(() => {
            propertiesSection.innerHTML = `
                <h5 class="mb-3">Type-Specific Properties</h5>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    Select a component type above to see available properties
                </div>
            `;
            selectedBrandsPreview.style.display = 'none';
        }, 100);
    });
});
</script>
{% endblock %}