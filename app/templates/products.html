{% extends "base.html" %}

{% block title %}Products - ComponentHub{% endblock %}

{% block extra_css %}
<style>
    .products-container {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
        padding: 1.5rem 0;
    }

    .filter-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        margin-bottom: 2rem;
        border: 1px solid rgba(255,255,255,0.8);
    }

    .results-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        border: 1px solid rgba(255,255,255,0.8);
        overflow: hidden;
    }

    .results-header {
        padding: 1.5rem 2rem;
        border-bottom: 1px solid #f1f3f4;
        background: #fafbfc;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .date-filter-section {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        background: #f8f9fa;
    }

    .date-input-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .date-input-group label {
        min-width: 80px;
        font-size: 0.9rem;
        font-weight: 500;
        margin: 0;
    }

    .date-input-group input {
        flex: 1;
        max-width: 200px;
    }

    .sort-controls {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .table-container {
        overflow-x: auto;
        max-height: 70vh;
    }

    .products-table {
        width: 100%;
        margin: 0;
    }

    .products-table th {
        background: #f8f9fa;
        border-bottom: 2px solid #e9ecef;
        font-weight: 600;
        font-size: 0.9rem;
        padding: 1rem 0.75rem;
        white-space: nowrap;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .products-table td {
        padding: 0.75rem;
        border-bottom: 1px solid #f1f3f4;
        font-size: 0.9rem;
        vertical-align: middle;
    }

    .product-title {
        max-width: 250px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-weight: 500;
    }

    .date-cell {
        font-size: 0.85rem;
        color: #6c757d;
        white-space: nowrap;
    }

    .date-time {
        display: block;
    }

    .date-ago {
        font-size: 0.75rem;
        color: #999;
        font-style: italic;
    }

    .shop-badge {
        background: #667eea;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.8rem;
        white-space: nowrap;
    }

    .status-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 500;
        text-transform: uppercase;
    }

    .status-active { background: #d4edda; color: #155724; }
    .status-draft { background: #fff3cd; color: #856404; }
    .status-archived { background: #f8d7da; color: #721c24; }

    .pagination-container {
        padding: 1.5rem 2rem;
        border-top: 1px solid #f1f3f4;
        background: #fafbfc;
    }

    .quick-date-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-top: 0.5rem;
    }

    .quick-date-btn {
        padding: 0.25rem 0.75rem;
        background: #e9ecef;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.8rem;
        text-decoration: none;
        color: #495057;
        transition: all 0.2s;
    }

    .quick-date-btn:hover {
        background: #667eea;
        color: white;
        text-decoration: none;
    }

    .form-check-inline {
        margin-right: 1rem;
        margin-bottom: 0.5rem;
    }

    @media (max-width: 768px) {
        .products-table th,
        .products-table td {
            padding: 0.5rem 0.25rem;
            font-size: 0.8rem;
        }

        .product-title {
            max-width: 150px;
        }

        .date-input-group {
            flex-direction: column;
            align-items: flex-start;
        }

        .date-input-group label {
            min-width: auto;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="products-container">
    <div class="container-fluid">

        <!-- Filters Section -->
        <div class="filter-card">
            <form method="GET" id="filterForm">
                <div class="row">
                    <!-- Basic Filters -->
                    <div class="col-lg-3 col-md-6 mb-3">
                        <label for="shop_filter" class="form-label">Shops</label>
                        <select multiple class="form-select" name="shop_ids[]" id="shop_filter">
                            {% for shop in shops %}
                            <option value="{{ shop.id }}"
                                    {% if shop.id|string in filters.getlist('shop_ids[]') %}selected{% endif %}>
                            {{ shop.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-lg-3 col-md-6 mb-3">
                        <label for="search_term" class="form-label">Search</label>
                        <input type="text" class="form-control" name="search_term" id="search_term"
                               value="{{ filters.get('search_term', '') }}"
                               placeholder="Title, SKU, Barcode, ID...">
                    </div>

                    <div class="col-lg-3 col-md-6 mb-3">
                        <label for="status_filter" class="form-label">Status</label>
                        <select class="form-select" name="status" id="status_filter">
                            <option value="">All Statuses</option>
                            <option value="active" {% if filters.get('status') == 'active' %}selected{% endif %}>Active</option>
                            <option value="draft" {% if filters.get('status') == 'draft' %}selected{% endif %}>Draft</option>
                            <option value="archived" {% if filters.get('status') == 'archived' %}selected{% endif %}>Archived</option>
                        </select>
                    </div>

                    <div class="col-lg-3 col-md-6 mb-3">
                        <label for="sort_by" class="form-label">Sort By</label>
                        <select class="form-select" name="sort_by" id="sort_by">
                            <option value="default" {% if filters.get('sort_by') == 'default' %}selected{% endif %}>Default (Shop, Title)</option>
                            <option value="created_desc" {% if filters.get('sort_by') == 'created_desc' %}selected{% endif %}>Latest Created</option>
                            <option value="created_asc" {% if filters.get('sort_by') == 'created_asc' %}selected{% endif %}>Oldest Created</option>
                            <option value="updated_desc" {% if filters.get('sort_by') == 'updated_desc' %}selected{% endif %}>Latest Updated</option>
                            <option value="updated_asc" {% if filters.get('sort_by') == 'updated_asc' %}selected{% endif %}>Oldest Updated</option>
                        </select>
                    </div>
                </div>

                <!-- Date Filters Section -->
                <div class="date-filter-section">
                    <h6 class="mb-3">Date Filters</h6>

                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label"><strong>Created Date</strong></label>
                            <div class="date-input-group">
                                <label for="created_after">After:</label>
                                <input type="datetime-local" class="form-control" name="created_after" id="created_after"
                                       value="{{ filters.get('created_after', '') }}">
                            </div>
                            <div class="date-input-group">
                                <label for="created_before">Before:</label>
                                <input type="datetime-local" class="form-control" name="created_before" id="created_before"
                                       value="{{ filters.get('created_before', '') }}">
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label"><strong>Updated Date</strong></label>
                            <div class="date-input-group">
                                <label for="updated_after">After:</label>
                                <input type="datetime-local" class="form-control" name="updated_after" id="updated_after"
                                       value="{{ filters.get('updated_after', '') }}">
                            </div>
                            <div class="date-input-group">
                                <label for="updated_before">Before:</label>
                                <input type="datetime-local" class="form-control" name="updated_before" id="updated_before"
                                       value="{{ filters.get('updated_before', '') }}">
                            </div>
                        </div>
                    </div>

                    <!-- Quick Date Buttons -->
                    <div class="quick-date-buttons">
                        <a href="#" class="quick-date-btn" onclick="setQuickDate('today')">Today</a>
                        <a href="#" class="quick-date-btn" onclick="setQuickDate('yesterday')">Yesterday</a>
                        <a href="#" class="quick-date-btn" onclick="setQuickDate('week')">This Week</a>
                        <a href="#" class="quick-date-btn" onclick="setQuickDate('month')">This Month</a>
                        <a href="#" class="quick-date-btn" onclick="clearDates()">Clear Dates</a>
                    </div>
                </div>

                <!-- Data Quality Filters -->
                <div class="row">
                    <div class="col-md-12">
                        <h6>Data Quality Filters</h6>
                        <div class="form-check-inline">
                            <input class="form-check-input" type="checkbox" name="missing_sku" id="missing_sku" value="1"
                                   {% if filters.get('missing_sku') %}checked{% endif %}>
                            <label class="form-check-label" for="missing_sku">Missing SKU</label>
                        </div>
                        <div class="form-check-inline">
                            <input class="form-check-input" type="checkbox" name="missing_barcode" id="missing_barcode" value="1"
                                   {% if filters.get('missing_barcode') %}checked{% endif %}>
                            <label class="form-check-label" for="missing_barcode">Missing Barcode</label>
                        </div>
                        <div class="form-check-inline">
                            <input class="form-check-input" type="checkbox" name="missing_images" id="missing_images" value="1"
                                   {% if filters.get('missing_images') %}checked{% endif %}>
                            <label class="form-check-label" for="missing_images">Missing Images</label>
                        </div>
                        <div class="form-check-inline">
                            <input class="form-check-input" type="checkbox" name="zero_inventory" id="zero_inventory" value="1"
                                   {% if filters.get('zero_inventory') %}checked{% endif %}>
                            <label class="form-check-label" for="zero_inventory">Zero Inventory</label>
                        </div>
                        <div class="form-check-inline">
                            <input class="form-check-input" type="checkbox" name="missing_title_tag" id="missing_title_tag" value="1"
                                   {% if filters.get('missing_title_tag') %}checked{% endif %}>
                            <label class="form-check-label" for="missing_title_tag">Missing SEO Title</label>
                        </div>
                        <div class="form-check-inline">
                            <input class="form-check-input" type="checkbox" name="missing_description_tag" id="missing_description_tag" value="1"
                                   {% if filters.get('missing_description_tag') %}checked{% endif %}>
                            <label class="form-check-label" for="missing_description_tag">Missing SEO Description</label>
                        </div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">
                            <i data-lucide="search" width="16" height="16" class="me-1"></i>
                            Apply Filters
                        </button>
                        <a href="{{ url_for('main.products') }}" class="btn btn-outline-secondary">
                            <i data-lucide="x" width="16" height="16" class="me-1"></i>
                            Clear All
                        </a>
                        {% if filters %}
                        <a href="{{ url_for('main.export_products', **filters) }}" class="btn btn-success">
                            <i data-lucide="download" width="16" height="16" class="me-1"></i>
                            Export Results
                        </a>
                        {% endif %}
                    </div>
                </div>
            </form>
        </div>

        <!-- Results Section -->
        <div class="results-card">
            <div class="results-header">
                <div>
                    <h5 class="mb-1">
                        <i data-lucide="package" width="20" height="20" class="me-2"></i>
                        Products
                    </h5>
                    <small class="text-muted">
                        Showing {{ pagination.showing_from }}-{{ pagination.showing_to }} of {{ "{:,}".format(pagination.total) }} results
                        {% if load_time %}(Loaded in {{ "%.2f"|format(load_time) }}s){% endif %}
                    </small>
                </div>
                <div class="sort-controls">
                    <label for="per_page" class="form-label mb-0">Per page:</label>
                    <select class="form-select" name="per_page" id="per_page" style="width: auto;" onchange="updatePerPage()">
                        <option value="25" {% if pagination.per_page == 25 %}selected{% endif %}>25</option>
                        <option value="50" {% if pagination.per_page == 50 %}selected{% endif %}>50</option>
                        <option value="100" {% if pagination.per_page == 100 %}selected{% endif %}>100</option>
                        <option value="200" {% if pagination.per_page == 200 %}selected{% endif %}>200</option>
                    </select>
                </div>
            </div>

            {% if products %}
            <div class="table-container">
                <table class="table table-hover products-table">
                    <thead>
                    <tr>
                        <th>Shop</th>
                        <th>Product Title</th>
                        <th>SKU</th>
                        <th>Barcode</th>
                        <th>Status</th>
                        <th>Inventory</th>
                        <th>Created</th>
                        <th>Updated</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for product in products %}
                    <tr>
                        <td>
                            <span class="shop-badge">{{ product.shop_technical_name }}</span>
                        </td>
                        <td>
                            <div class="product-title" title="{{ product.title }}">
                                {{ product.title }}
                            </div>
                            <small class="text-muted">{{ product.handle }}</small>
                        </td>
                        <td>
                            {% if product.variant_sku %}
                            <code>{{ product.variant_sku }}</code>
                            {% else %}
                            <span class="text-danger">
                                        <i data-lucide="alert-triangle" width="14" height="14"></i>
                                        Missing
                                    </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if product.variant_barcode %}
                            <code>{{ product.variant_barcode }}</code>
                            {% else %}
                            <span class="text-danger">
                                        <i data-lucide="alert-triangle" width="14" height="14"></i>
                                        Missing
                                    </span>
                            {% endif %}
                        </td>
                        <td>
                                <span class="status-badge status-{{ product.status|lower }}">
                                    {{ product.status|title }}
                                </span>
                        </td>
                        <td>
                            {% if product.variant_inventory_quantity is not none %}
                            {% if product.variant_inventory_quantity == 0 %}
                            <span class="text-danger">{{ product.variant_inventory_quantity }}</span>
                            {% else %}
                            <span class="text-success">{{ product.variant_inventory_quantity }}</span>
                            {% endif %}
                            {% else %}
                            <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td class="date-cell">
                            {% if product.created_at %}
                            <div class="date-time">{{ product.created_at.strftime('%Y-%m-%d %H:%M') if product.created_at else 'N/A' }}</div>
                            <div class="date-ago" id="created-{{ loop.index }}"></div>
                            {% else %}
                            <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td class="date-cell">
                            {% if product.updated_at %}
                            <div class="date-time">{{ product.updated_at.strftime('%Y-%m-%d %H:%M') if product.updated_at else 'N/A' }}</div>
                            <div class="date-ago" id="updated-{{ loop.index }}"></div>
                            {% else %}
                            <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-outline-primary"
                                        onclick="showProductDetails({{ product.product_id }})"
                                        title="View Product Details">
                                    <i data-lucide="eye" width="14" height="14"></i>
                                </button>
                                {% if product.variant_barcode %}
                                <button type="button" class="btn btn-sm btn-outline-secondary"
                                        onclick="searchBarcode('{{ product.variant_barcode }}')"
                                        title="Find Similar Products">
                                    <i data-lucide="search" width="14" height="14"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="pagination-container">
                <nav>
                    <ul class="pagination justify-content-center mb-0">
                        {% if pagination.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('main.products', page=pagination.prev_page, **filters) }}">
                                <i data-lucide="chevron-left" width="16" height="16"></i>
                                Previous
                            </a>
                        </li>
                        {% endif %}

                        {% for page_num in range(1, pagination.pages + 1) %}
                        {% if page_num == pagination.page %}
                        <li class="page-item active">
                            <span class="page-link">{{ page_num }}</span>
                        </li>
                        {% elif page_num <= 3 or page_num > pagination.pages - 3 or (page_num >= pagination.page - 2 and page_num <= pagination.page + 2) %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('main.products', page=page_num, **filters) }}">{{ page_num }}</a>
                        </li>
                        {% elif page_num == 4 or page_num == pagination.pages - 3 %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                        {% endif %}
                        {% endfor %}

                        {% if pagination.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('main.products', page=pagination.next_page, **filters) }}">
                                Next
                                <i data-lucide="chevron-right" width="16" height="16"></i>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>

            {% else %}
            <div class="text-center py-5">
                <i data-lucide="package-x" width="64" height="64" class="text-muted mb-3"></i>
                <h5>No products found</h5>
                <p class="text-muted">Try adjusting your filters to see more results.</p>
                <a href="{{ url_for('main.products') }}" class="btn btn-outline-primary">
                    <i data-lucide="refresh-cw" width="16" height="16" class="me-1"></i>
                    Clear All Filters
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Hidden data for JavaScript -->
<script type="application/json" id="product-dates">
    {
        "products": [
            {% for product in products %}
            {
                "index": {{ loop.index }},
            "created_at": "{{ product.created_at.isoformat() if product.created_at else '' }}",
            "updated_at": "{{ product.updated_at.isoformat() if product.updated_at else '' }}"
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ]
    }
</script>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        lucide.createIcons();

        // Initialize relative dates
        initializeRelativeDates();
    });

    function initializeRelativeDates() {
        try {
            const productDatesData = document.getElementById('product-dates');
            if (productDatesData && window.moment) {
                const data = JSON.parse(productDatesData.textContent);

                data.products.forEach(product => {
                    if (product.created_at) {
                        const createdElement = document.getElementById(`created-${product.index}`);
                        if (createdElement) {
                            createdElement.textContent = moment(product.created_at).fromNow();
                        }
                    }

                    if (product.updated_at) {
                        const updatedElement = document.getElementById(`updated-${product.index}`);
                        if (updatedElement) {
                            updatedElement.textContent = moment(product.updated_at).fromNow();
                        }
                    }
                });
            }
        } catch (e) {
            console.warn('Could not initialize relative dates:', e);
        }
    }

    function updatePerPage() {
        const perPage = document.getElementById('per_page').value;
        const url = new URL(window.location);
        url.searchParams.set('per_page', perPage);
        url.searchParams.set('page', 1); // Reset to first page
        window.location.href = url.toString();
    }

    function setQuickDate(period) {
        const now = new Date();
        let startDate;

        switch(period) {
            case 'today':
                startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                break;
            case 'yesterday':
                startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
                break;
            case 'week':
                const dayOfWeek = now.getDay();
                startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - dayOfWeek);
                break;
            case 'month':
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                break;
        }

        if (startDate) {
            document.getElementById('created_after').value = formatDateTimeLocal(startDate);
            document.getElementById('updated_after').value = formatDateTimeLocal(startDate);
        }
    }

    function clearDates() {
        document.getElementById('created_after').value = '';
        document.getElementById('created_before').value = '';
        document.getElementById('updated_after').value = '';
        document.getElementById('updated_before').value = '';
    }

    function formatDateTimeLocal(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}T00:00`;
    }

    function showProductDetails(productId) {
        // You can implement a modal or redirect to product details
        console.log('Show details for product:', productId);
        // Example: window.open(`/product/${productId}`, '_blank');
    }

    function searchBarcode(barcode) {
        const url = new URL(window.location);
        url.searchParams.set('search_term', barcode);
        url.searchParams.set('page', 1);
        window.location.href = url.toString();
    }

    // Auto-submit form on Enter key in search field
    document.getElementById('search_term').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('filterForm').submit();
        }
    });

    // Update pagination info in real-time
    function updatePaginationInfo() {
        const params = new URLSearchParams(window.location.search);
        const page = params.get('page') || 1;
        const perPage = params.get('per_page') || 50;

        // Update per_page selector if not already set
        const perPageSelect = document.getElementById('per_page');
        if (perPageSelect && perPageSelect.value != perPage) {
            perPageSelect.value = perPage;
        }
    }

    // Initialize pagination info
    updatePaginationInfo();
</script>
{% endblock %}