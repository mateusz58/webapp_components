{% extends "base.html" %}

{% block title %}{{ 'Edit' if component else 'New' }} Component - ComponentHub{% endblock %}

{% block extra_css %}
<style>
    .form-wizard {
        background: white;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-md);
        overflow: hidden;
    }

    .wizard-header {
        background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
        color: white;
        padding: 2rem;
        position: relative;
        overflow: hidden;
    }

    .wizard-header::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 120px;
        height: 120px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        transform: translate(40px, -40px);
    }

    .wizard-steps {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2rem;
        position: relative;
        z-index: 2;
    }

    .wizard-step {
        display: flex;
        align-items: center;
        flex: 1;
        position: relative;
    }

    .wizard-step:not(:last-child)::after {
        content: '';
        position: absolute;
        top: 15px;
        right: -50%;
        left: 50%;
        height: 2px;
        background: rgba(255, 255, 255, 0.3);
        z-index: 1;
    }

    .wizard-step.completed:not(:last-child)::after {
        background: rgba(255, 255, 255, 0.8);
    }

    .step-indicator {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        margin-right: 0.75rem;
        position: relative;
        z-index: 2;
        transition: all 0.3s ease;
    }

    .wizard-step.active .step-indicator {
        background: white;
        color: var(--color-primary);
        transform: scale(1.1);
    }

    .wizard-step.completed .step-indicator {
        background: rgba(255, 255, 255, 0.9);
        color: var(--color-primary);
    }

    .step-title {
        font-weight: 500;
        font-size: 0.9rem;
    }

    .wizard-content {
        padding: 2rem;
        min-height: 500px;
    }

    .step-content {
        display: none;
    }

    .step-content.active {
        display: block;
        animation: fadeInUp 0.4s ease;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .form-section {
        background: #f8fafc;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border-left: 4px solid var(--color-primary);
    }

    .section-title {
        font-weight: 600;
        margin-bottom: 1rem;
        color: var(--color-dark);
        display: flex;
        align-items: center;
    }

    /* Brand Selection Styles */
    .brand-selection {
        background: white;
        border-radius: var(--border-radius);
        border: 2px solid #e2e8f0;
        padding: 1rem;
        transition: all 0.2s ease;
    }

    .brand-selection:focus-within {
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .brand-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.75rem;
        min-height: 40px;
        padding: 0.75rem;
        border: 2px solid #e2e8f0;
        border-radius: var(--border-radius);
        background: white;
    }

    .brand-tag {
        background: var(--color-primary);
        color: white;
        padding: 0.375rem 0.75rem;
        border-radius: 20px;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        animation: fadeIn 0.3s ease;
    }

    .brand-remove {
        cursor: pointer;
        opacity: 0.7;
        transition: opacity 0.2s ease;
        padding: 0.125rem;
        border-radius: 50%;
    }

    .brand-remove:hover {
        opacity: 1;
        background: rgba(255, 255, 255, 0.2);
    }

    /* Image Upload Styles */
    .image-upload-area {
        border: 2px dashed #cbd5e1;
        border-radius: var(--border-radius);
        padding: 3rem 2rem;
        text-align: center;
        background: #f8fafc;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

    .image-upload-area:hover {
        border-color: var(--color-primary);
        background: #f0f7ff;
        transform: translateY(-2px);
    }

    .image-upload-area.dragover {
        border-color: var(--color-primary);
        background: #e0f2fe;
        transform: scale(1.02);
        border-style: solid;
    }

    .upload-placeholder {
        color: var(--color-secondary);
    }

    .upload-stats {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin-top: 1.5rem;
        font-size: 0.875rem;
        color: var(--color-secondary);
    }

    .image-preview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .preview-item {
        position: relative;
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--shadow-sm);
        background: white;
        border: 1px solid #e2e8f0;
        transition: all 0.2s ease;
    }

    .preview-item:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .preview-image {
        width: 100%;
        height: 120px;
        object-fit: cover;
    }

    .preview-info {
        padding: 0.75rem;
    }

    .preview-actions {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        display: flex;
        gap: 0.25rem;
    }

    .preview-btn {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: none;
        background: rgba(220, 38, 38, 0.9);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        backdrop-filter: blur(5px);
    }

    .preview-btn:hover {
        background: rgba(220, 38, 38, 1);
        transform: scale(1.1);
    }

    /* Keyword Input Styles */
    .keyword-input-container {
        position: relative;
    }

    .keyword-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }

    .keyword-suggestions.show {
        display: block;
    }

    .suggestion-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        transition: background 0.2s ease;
        border-bottom: 1px solid #f1f5f9;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .suggestion-item:hover {
        background: #f8fafc;
    }

    .suggestion-item:last-child {
        border-bottom: none;
    }

    .keyword-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.75rem;
        min-height: 40px;
        padding: 0.75rem;
        border: 2px solid #e2e8f0;
        border-radius: var(--border-radius);
        background: white;
        transition: border-color 0.2s ease;
    }

    .keyword-tags:focus-within {
        border-color: var(--color-primary);
    }

    .keyword-tag {
        background: var(--color-primary);
        color: white;
        padding: 0.375rem 0.75rem;
        border-radius: 20px;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        animation: fadeIn 0.3s ease;
    }

    .keyword-remove {
        cursor: pointer;
        opacity: 0.7;
        transition: opacity 0.2s ease;
        padding: 0.125rem;
        border-radius: 50%;
    }

    .keyword-remove:hover {
        opacity: 1;
        background: rgba(255, 255, 255, 0.2);
    }

    /* Properties Grid */
    .properties-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1rem;
    }

    .property-field {
        background: white;
        border-radius: var(--border-radius);
        padding: 1rem;
        border: 1px solid #e2e8f0;
        transition: all 0.2s ease;
    }

    .property-field:hover {
        border-color: var(--color-primary);
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
    }

    .property-field:focus-within {
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    /* Validation */
    .validation-error {
        color: var(--color-danger);
        font-size: 0.875rem;
        margin-top: 0.25rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .field-valid {
        border-color: var(--color-success) !important;
    }

    .field-invalid {
        border-color: var(--color-danger) !important;
    }

    /* Progress Bar */
    .progress-bar {
        height: 4px;
        background: #e2e8f0;
        border-radius: 2px;
        overflow: hidden;
        margin-bottom: 2rem;
        position: relative;
        z-index: 2;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, white, rgba(255, 255, 255, 0.8));
        transition: width 0.3s ease;
        border-radius: 2px;
    }

    /* Wizard Navigation */
    .wizard-navigation {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem 2rem;
        background: #f8fafc;
        border-top: 1px solid #e2e8f0;
    }

    /* Live Preview */
    .live-preview {
        background: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        border: 1px solid #e2e8f0;
        position: sticky;
        top: 120px;
        max-height: calc(100vh - 140px);
        overflow-y: auto;
    }

    .preview-card {
        border: 1px solid #e2e8f0;
        border-radius: var(--border-radius);
        overflow: hidden;
        background: white;
        box-shadow: var(--shadow-sm);
    }

    .preview-image-area {
        height: 150px;
        background: #f1f5f9;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--color-secondary);
    }

    .preview-content {
        padding: 1rem;
    }

    /* Auto-save indicator */
    .auto-save-indicator {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        background: var(--color-success);
        color: white;
        padding: 0.75rem 1rem;
        border-radius: 25px;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s ease;
        z-index: 1000;
        box-shadow: var(--shadow-md);
    }

    .auto-save-indicator.show {
        opacity: 1;
        transform: translateY(0);
    }

    /* Form field improvements */
    .form-control-modern:focus {
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-select-modern:focus {
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .wizard-content {
            padding: 1rem;
        }

        .wizard-header {
            padding: 1.5rem;
        }

        .form-section {
            padding: 1rem;
        }

        .image-upload-area {
            padding: 2rem 1rem;
        }

        .upload-stats {
            flex-direction: column;
            gap: 0.5rem;
        }

        .properties-grid {
            grid-template-columns: 1fr;
        }

        .wizard-navigation {
            padding: 1rem;
        }

        .live-preview {
            position: static;
            margin-top: 2rem;
        }
    }

    /* Loading states */
    .loading {
        opacity: 0.6;
        pointer-events: none;
    }

    .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #ffffff;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.8); }
        to { opacity: 1; transform: scale(1); }
    }

    /* Variant Management Styles */
    .variant-card {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: var(--border-radius);
        padding: 1rem;
        transition: all 0.2s ease;
        height: 100%;
    }

    .variant-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    .variant-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .variant-color-indicator {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 2px solid #e2e8f0;
        flex-shrink: 0;
    }

    .variant-info {
        flex: 1;
        min-width: 0;
    }

    .variant-info h6 {
        margin: 0;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--color-dark);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .variant-actions {
        display: flex;
        gap: 0.25rem;
        flex-shrink: 0;
    }

    .variant-actions .btn {
        padding: 0.25rem;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .variant-images {
        margin-bottom: 0.75rem;
    }

    .variant-image-preview {
        display: flex;
        gap: 0.25rem;
        margin-bottom: 0.5rem;
    }

    .variant-thumbnail {
        width: 40px;
        height: 40px;
        object-fit: cover;
        border-radius: 4px;
        border: 1px solid #e2e8f0;
    }

    .variant-thumbnail-more {
        width: 40px;
        height: 40px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        color: #64748b;
        font-weight: 500;
    }

    .variant-no-images {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
        padding: 1rem;
        background: #f8fafc;
        border-radius: 4px;
        border: 1px dashed #cbd5e1;
    }

    .variant-description {
        padding-top: 0.75rem;
        border-top: 1px solid #f1f5f9;
    }

    .variant-description small {
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* Responsive variant grid */
    @media (max-width: 768px) {
        .variant-card {
            margin-bottom: 1rem;
        }
        
        .variant-header {
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .variant-actions {
            width: 100%;
            justify-content: flex-end;
        }
        
        .variant-image-preview {
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div x-data="componentForm()" class="fade-in">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-dark fw-bold">
                {{ 'Edit Component' if component else 'Create New Component' }}
            </h1>
            <p class="text-muted mb-0">
                {{ 'Modify component details and properties' if component else 'Add a new component to your library' }}
            </p>
        </div>
        <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary">
            <i data-lucide="arrow-left" class="me-2" style="width: 16px; height: 16px;"></i>
            Back to List
        </a>
    </div>

    <div class="row">
        <!-- Main Form -->
        <div class="col-lg-8">
            <form method="POST" enctype="multipart/form-data" x-ref="mainForm" @submit="handleSubmit">
                <div class="form-wizard">
                    <!-- Wizard Header -->
                    <div class="wizard-header">
                        <!-- Progress Bar -->
                        <div class="progress-bar">
                            <div class="progress-fill" :style="{ width: ((currentStep) / totalSteps * 100) + '%' }"></div>
                        </div>

                        <!-- Wizard Steps -->
                        <div class="wizard-steps">
                            <div class="wizard-step" :class="{ 'active': currentStep === 1, 'completed': currentStep > 1 }">
                                <div class="step-indicator">
                                    <i data-lucide="info" x-show="currentStep === 1" style="width: 16px; height: 16px;"></i>
                                    <i data-lucide="check" x-show="currentStep > 1" style="width: 16px; height: 16px;"></i>
                                    <span x-show="currentStep !== 1 && currentStep <= 1">1</span>
                                </div>
                                <div class="step-title">Basic Info</div>
                            </div>
                            <div class="wizard-step" :class="{ 'active': currentStep === 2, 'completed': currentStep > 2 }">
                                <div class="step-indicator">
                                    <i data-lucide="tag" x-show="currentStep === 2" style="width: 16px; height: 16px;"></i>
                                    <i data-lucide="check" x-show="currentStep > 2" style="width: 16px; height: 16px;"></i>
                                    <span x-show="currentStep !== 2 && currentStep <= 2">2</span>
                                </div>
                                <div class="step-title">Brands</div>
                            </div>
                            <div class="wizard-step" :class="{ 'active': currentStep === 3, 'completed': currentStep > 3 }">
                                <div class="step-indicator">
                                    <i data-lucide="settings" x-show="currentStep === 3" style="width: 16px; height: 16px;"></i>
                                    <i data-lucide="check" x-show="currentStep > 3" style="width: 16px; height: 16px;"></i>
                                    <span x-show="currentStep !== 3 && currentStep <= 3">3</span>
                                </div>
                                <div class="step-title">Properties</div>
                            </div>
                            <div class="wizard-step" :class="{ 'active': currentStep === 4, 'completed': currentStep > 4 }">
                                <div class="step-indicator">
                                    <i data-lucide="images" x-show="currentStep === 4" style="width: 16px; height: 16px;"></i>
                                    <i data-lucide="check" x-show="currentStep > 4" style="width: 16px; height: 16px;"></i>
                                    <span x-show="currentStep !== 4 && currentStep <= 4">4</span>
                                </div>
                                <div class="step-title">Images</div>
                            </div>
                            <div class="wizard-step" :class="{ 'active': currentStep === 5, 'completed': currentStep > 5 }">
                                <div class="step-indicator">
                                    <i data-lucide="hash" x-show="currentStep === 5" style="width: 16px; height: 16px;"></i>
                                    <i data-lucide="check" x-show="currentStep > 5" style="width: 16px; height: 16px;"></i>
                                    <span x-show="currentStep !== 5 && currentStep <= 5">5</span>
                                </div>
                                <div class="step-title">Keywords & Review</div>
                            </div>
                            <div class="wizard-step" :class="{ 'active': currentStep === 6, 'completed': currentStep > 6 }">
                                <div class="step-indicator">
                                    <i data-lucide="palette" x-show="currentStep === 6" style="width: 16px; height: 16px;"></i>
                                    <i data-lucide="check" x-show="currentStep > 6" style="width: 16px; height: 16px;"></i>
                                    <span x-show="currentStep !== 6 && currentStep <= 6">6</span>
                                </div>
                                <div class="step-title">Variants</div>
                            </div>
                        </div>
                    </div>

                    <!-- Wizard Content -->
                    <div class="wizard-content">
                        <!-- Step 1: Basic Information -->
                        <div class="step-content" :class="{ 'active': currentStep === 1 }">
                            <div class="form-section">
                                <h5 class="section-title">
                                    <i data-lucide="info" class="me-2" style="width: 20px; height: 20px;"></i>
                                    Component Details
                                </h5>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="product_number" class="form-label form-label-modern">
                                                Product Number *
                                            </label>
                                            <input type="text"
                                                   class="form-control form-control-modern"
                                                   id="product_number"
                                                   name="product_number"
                                                   x-model="formData.product_number"
                                                   @input="validateField('product_number'); autoSave()"
                                                   :class="{ 'field-valid': !errors.product_number && formData.product_number, 'field-invalid': errors.product_number }"
                                                   value="{{ component.product_number if component else '' }}"
                                                   required>
                                            <div class="form-text">e.g., F-WL001 for Fabrics, S-WL0001 for Shapes</div>
                                            <div class="validation-error" x-show="errors.product_number">
                                                <i data-lucide="alert-circle" style="width: 14px; height: 14px;"></i>
                                                <span x-text="errors.product_number"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="component_type_id" class="form-label form-label-modern">
                                                Component Type *
                                            </label>
                                            <select class="form-select form-control-modern"
                                                    id="component_type_id"
                                                    name="component_type_id"
                                                    x-model="formData.component_type_id"
                                                    @change="loadComponentTypeProperties(); validateField('component_type_id'); autoSave()"
                                                    :class="{ 'field-valid': !errors.component_type_id && formData.component_type_id, 'field-invalid': errors.component_type_id }"
                                                    required>
                                                <option value="">Select Component Type</option>
                                                {% for component_type in component_types %}
                                                <option value="{{ component_type.id }}"
                                                        {% if component and component.component_type_id == component_type.id %}selected{% endif %}>
                                                    {{ component_type.name }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                            <div class="validation-error" x-show="errors.component_type_id">
                                                <i data-lucide="alert-circle" style="width: 14px; height: 14px;"></i>
                                                <span x-text="errors.component_type_id"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="supplier_id" class="form-label form-label-modern">
                                                Supplier *
                                            </label>
                                            <select class="form-select form-control-modern"
                                                    id="supplier_id"
                                                    name="supplier_id"
                                                    x-model="formData.supplier_id"
                                                    @change="validateField('supplier_id'); autoSave()"
                                                    :class="{ 'field-valid': !errors.supplier_id && formData.supplier_id, 'field-invalid': errors.supplier_id }"
                                                    required>
                                                <option value="">Select Supplier</option>
                                                {% for supplier in suppliers %}
                                                <option value="{{ supplier.id }}"
                                                        {% if component and component.supplier_id == supplier.id %}selected{% endif %}>
                                                    {{ supplier.supplier_code }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                            <div class="validation-error" x-show="errors.supplier_id">
                                                <i data-lucide="alert-circle" style="width: 14px; height: 14px;"></i>
                                                <span x-text="errors.supplier_id"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="category_id" class="form-label form-label-modern">
                                                Category *
                                            </label>
                                            <select class="form-select form-control-modern"
                                                    id="category_id"
                                                    name="category_id"
                                                    x-model="formData.category_id"
                                                    @change="validateField('category_id'); autoSave()"
                                                    :class="{ 'field-valid': !errors.category_id && formData.category_id, 'field-invalid': errors.category_id }"
                                                    required>
                                                <option value="">Select Category</option>
                                                {% for category in categories %}
                                                <option value="{{ category.id }}"
                                                        {% if component and component.category_id == category.id %}selected{% endif %}>
                                                    {{ category.name }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                            <div class="validation-error" x-show="errors.category_id">
                                                <i data-lucide="alert-circle" style="width: 14px; height: 14px;"></i>
                                                <span x-text="errors.category_id"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="description" class="form-label form-label-modern">Description</label>
                                    <textarea class="form-control form-control-modern"
                                              id="description"
                                              name="description"
                                              rows="4"
                                              x-model="formData.description"
                                              @input="autoSave()"
                                              placeholder="Detailed description of the component...">{{ component.description if component else '' }}</textarea>
                                    <div class="form-text">
                                        <span x-text="formData.description ? formData.description.length : 0"></span> characters
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Brand Selection -->
                        <!-- Step 2: Brand Selection - FIXED -->
<div class="step-content" :class="{ 'active': currentStep === 2 }">
    <div class="form-section">
        <h5 class="section-title">
            <i data-lucide="tag" class="me-2" style="width: 20px; height: 20px;"></i>
            Brand Association
        </h5>

        <div class="mb-3">
            <label class="form-label form-label-modern">Select Brands</label>
            <div class="brand-selection">
                <select class="form-select form-control-modern"
                        x-model="selectedBrandId"
                        @change="addBrand()">
                    <option value="">Choose a brand to add...</option>
                    <!-- FIXED: Use server-side brands data directly -->
                    {% if brands %}
                    {% for brand in brands %}
                    <option value="{{ brand.id }}">{{ brand.name }}</option>
                    {% endfor %}
                    {% endif %}
                </select>
                <div class="form-text">
                    You can associate this component with multiple brands. Select from the dropdown to add.
                </div>
            </div>
        </div>

        <!-- Selected Brands Display -->
        <div class="brand-tags">
            <template x-for="(brand, index) in selectedBrands" :key="brand.id || index">
                <span class="brand-tag">
                    <span x-text="brand.name || 'Unknown Brand'"></span>
                    <span class="brand-remove" @click="removeBrand(index)">
                        <i data-lucide="x" style="width: 14px; height: 14px;"></i>
                    </span>
                </span>
            </template>
            <div x-show="selectedBrands.length === 0" class="text-muted text-center p-2">
                <i data-lucide="tag" style="width: 20px; height: 20px;"></i>
                <p class="mb-0 mt-1">No brands selected yet</p>
            </div>
        </div>

        <!-- Hidden inputs for form submission -->
        <template x-for="brand in selectedBrands" :key="brand.id || brand.name">
            <input type="hidden" name="brands" :value="brand.id">
        </template>
    </div>
</div>

                        <!-- Step 3: Properties -->
                        <div class="step-content" :class="{ 'active': currentStep === 3 }">
                            <div class="form-section">
                                <h5 class="section-title">
                                    <i data-lucide="settings" class="me-2" style="width: 20px; height: 20px;"></i>
                                    Component Properties
                                </h5>

                                <div x-show="!availableProperties.length" class="text-center py-5">
                                    <i data-lucide="info" style="width: 48px; height: 48px; color: var(--color-secondary);"></i>
                                    <p class="text-muted mt-3 mb-0">Select a component type to see available properties</p>
                                </div>

                                <div x-show="availableProperties.length > 0" class="properties-grid">
                                    <template x-for="property in availableProperties" :key="property">
                                        <div class="property-field">
                                            <label :for="property" class="form-label form-label-modern" x-text="capitalizeFirst(property)"></label>

                                            <!-- Text Input -->
                                            <template x-if="propertyTypes[property] === 'text'">
                                                <input type="text"
                                                       class="form-control form-control-modern"
                                                       :id="property"
                                                       :name="property"
                                                       x-model="formData.properties[property]"
                                                       @input="autoSave()"
                                                       :placeholder="propertyPlaceholders[property] || 'Enter ' + property">
                                            </template>

                                            <!-- Select Input -->
                                            <template x-if="propertyTypes[property] === 'select'">
                                                <select class="form-select form-control-modern"
                                                        :id="property"
                                                        :name="property"
                                                        x-model="formData.properties[property]"
                                                        @change="autoSave()">
                                                    <option value="">Select <span x-text="property"></span></option>
                                                    <template x-for="option in propertyOptions[property] || []" :key="option">
                                                        <option :value="option" x-text="option"></option>
                                                    </template>
                                                </select>
                                            </template>

                                            <!-- Multi-select -->
                                            <template x-if="propertyTypes[property] === 'multiselect'">
                                                <div>
                                                    <select multiple class="form-select form-control-modern"
                                                            :id="property"
                                                            :name="property"
                                                            x-model="formData.properties[property]"
                                                            @change="autoSave()"
                                                            style="min-height: 100px;">
                                                        <template x-for="option in propertyOptions[property] || []" :key="option">
                                                            <option :value="option" x-text="option"></option>
                                                        </template>
                                                    </select>
                                                    <div class="form-text">Hold Ctrl/Cmd to select multiple options</div>
                                                </div>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>

                        <!-- Step 4: Images -->
                        <div class="step-content" :class="{ 'active': currentStep === 4 }">
                            <div class="form-section">
                                <h5 class="section-title">
                                    <i data-lucide="images" class="me-2" style="width: 20px; height: 20px;"></i>
                                    Component Images
                                </h5>

                                <!-- Image Upload Area -->
                                <div class="image-upload-area"
                                     @click="$refs.imageInput.click()"
                                     @dragover.prevent="dragOver = true"
                                     @dragleave.prevent="dragOver = false"
                                     @drop.prevent="handleImageDrop($event)"
                                     :class="{ 'dragover': dragOver }">

                                    <input type="file"
                                           x-ref="imageInput"
                                           multiple
                                           accept="image/*"
                                           style="display: none;"
                                           @change="handleImageSelect($event)">

                                    <div class="upload-placeholder">
                                        <i data-lucide="upload-cloud" style="width: 48px; height: 48px;" class="mb-3"></i>
                                        <h6>Drop images here or click to browse</h6>
                                        <p class="text-muted mb-0">Upload high-quality images of your component</p>
                                    </div>

                                    <div class="upload-stats">
                                        <span><i data-lucide="file-image" style="width: 14px; height: 14px;"></i> JPG, PNG, GIF supported</span>
                                        <span><i data-lucide="hard-drive" style="width: 14px; height: 14px;"></i> Max 10MB per file</span>
                                        <span><i data-lucide="layers" style="width: 14px; height: 14px;"></i> Multiple files allowed</span>
                                    </div>
                                </div>

                                <!-- Image Previews -->
                                <div x-show="images.length > 0" class="image-preview">
                                    <template x-for="(image, index) in images" :key="image.id">
                                        <div class="preview-item">
                                            <img :src="image.url" :alt="image.name" class="preview-image">
                                            <div class="preview-actions">
                                                <button type="button"
                                                        class="preview-btn"
                                                        @click="removeImage(index)"
                                                        title="Remove image">
                                                    <i data-lucide="x" style="width: 12px; height: 12px;"></i>
                                                </button>
                                            </div>
                                            <div class="preview-info">
                                                <input type="text"
                                                       class="form-control form-control-modern mb-2"
                                                       :value="image.name"
                                                       @input="updateImageName(index, $event.target.value)"
                                                       placeholder="Image name">
                                                <input type="number"
                                                       class="form-control form-control-modern"
                                                       :value="image.order"
                                                       @input="updateImageOrder(index, $event.target.value)"
                                                       min="1"
                                                       placeholder="Display order">
                                            </div>
                                        </div>
                                    </template>
                                </div>

                                <!-- Existing Images (for edit mode) -->
                                {% if component and component.pictures %}
                                <div class="mt-4">
                                    <h6 class="fw-bold mb-3">Existing Images</h6>
                                    <div class="image-preview">
                                        {% for picture in component.pictures|sort(attribute='picture_order') %}
                                        <div class="preview-item">
                                            <img src="{{ picture.url }}" alt="{{ picture.picture_name }}" class="preview-image">
                                            <div class="preview-info">
                                                <input type="text"
                                                       class="form-control form-control-modern mb-2"
                                                       name="existing_picture_{{ loop.index }}_name"
                                                       value="{{ picture.picture_name }}"
                                                       placeholder="Image name">
                                                <input type="number"
                                                       class="form-control form-control-modern"
                                                       name="existing_picture_{{ loop.index }}_order"
                                                       value="{{ picture.picture_order }}"
                                                       min="1"
                                                       placeholder="Display order">
                                                <input type="hidden"
                                                       name="existing_picture_{{ loop.index }}_url"
                                                       value="{{ picture.url }}">
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Step 5: Keywords & Review -->
                        <div class="step-content" :class="{ 'active': currentStep === 5 }">
                            <div class="form-section">
                                <h5 class="section-title">
                                    <i data-lucide="hash" class="me-2" style="width: 20px; height: 20px;"></i>
                                    Keywords
                                </h5>

                                <div class="keyword-input-container">
                                    <label for="keyword-input" class="form-label form-label-modern">
                                        Component Keywords
                                    </label>
                                    <input type="text"
                                           id="keyword-input"
                                           class="form-control form-control-modern"
                                           x-model="keywordInput"
                                           @input="searchKeywords()"
                                           @keydown.enter.prevent="addKeyword()"
                                           @keydown.comma.prevent="addKeyword()"
                                           @keydown.tab="addKeywordFromSuggestion()"
                                           placeholder="Type keywords and press Enter or comma to add...">

                                    <!-- Keyword Suggestions -->
                                    <div class="keyword-suggestions" :class="{ 'show': keywordSuggestions.length > 0 && keywordInput.length > 0 }">
                                        <template x-for="suggestion in keywordSuggestions" :key="suggestion">
                                            <div class="suggestion-item" @click="addKeywordFromSuggestion(suggestion)">
                                                <span x-text="suggestion"></span>
                                                <small class="text-muted">Popular</small>
                                            </div>
                                        </template>
                                    </div>
                                </div>

                                <!-- Selected Keywords -->
                                <div class="keyword-tags">
                                    <template x-for="(keyword, index) in keywords" :key="keyword">
                                        <span class="keyword-tag">
                                            <span x-text="keyword"></span>
                                            <span class="keyword-remove" @click="removeKeyword(index)">
                                                <i data-lucide="x" style="width: 14px; height: 14px;"></i>
                                            </span>
                                        </span>
                                    </template>
                                    <div x-show="keywords.length === 0" class="text-muted text-center p-2">
                                        <i data-lucide="hash" style="width: 20px; height: 20px;"></i>
                                        <p class="mb-0 mt-1">No keywords added yet</p>
                                    </div>
                                </div>

                                <!-- Hidden input for form submission -->
                                <input type="hidden" name="keywords" :value="keywords.join(',')">
                            </div>

                            <!-- Form Review -->
                            <div class="form-section">
                                <h5 class="section-title">
                                    <i data-lucide="eye" class="me-2" style="width: 20px; height: 20px;"></i>
                                    Review & Submit
                                </h5>

                                <div class="alert alert-modern alert-info">
                                    <div class="d-flex align-items-center">
                                        <i data-lucide="info" class="me-2" style="width: 20px; height: 20px;"></i>
                                        <div>
                                            <strong>Ready to submit!</strong>
                                            <p class="mb-0 mt-1">Review your component details in the preview panel, then click "Save Component" to finish.</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="fw-bold mb-2">Basic Information</h6>
                                        <ul class="list-unstyled text-muted">
                                            <li><strong>Product Number:</strong> <span x-text="formData.product_number || 'Not specified'"></span></li>
                                            <li><strong>Type:</strong> <span x-text="getSelectedText('component_type_id') || 'Not selected'"></span></li>
                                            <li><strong>Supplier:</strong> <span x-text="getSelectedText('supplier_id') || 'Not selected'"></span></li>
                                            <li><strong>Category:</strong> <span x-text="getSelectedText('category_id') || 'Not selected'"></span></li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="fw-bold mb-2">Additional Details</h6>
                                        <ul class="list-unstyled text-muted">
                                            <li><strong>Brands:</strong> <span x-text="selectedBrands.length"></span> selected</li>
                                            <li><strong>Properties:</strong> <span x-text="Object.keys(formData.properties || {}).filter(key => formData.properties[key]).length"></span> defined</li>
                                            <li><strong>Images:</strong> <span x-text="images.length"></span> uploaded</li>
                                            <li><strong>Keywords:</strong> <span x-text="keywords.length"></span> added</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 6: Variants -->
                        <div class="step-content" :class="{ 'active': currentStep === 6 }">
                            <div class="form-section">
                                <h5 class="section-title">
                                    <i data-lucide="palette" class="me-2" style="width: 20px; height: 20px;"></i>
                                    Color Variants
                                </h5>
                                
                                <p class="text-muted mb-4">
                                    Manage color variants for this component. Each variant can have its own set of images.
                                </p>

                                <!-- Existing Variants -->
                                {% if component and component.variants %}
                                <div class="mb-4">
                                    <h6 class="fw-bold mb-3">
                                        <i data-lucide="list" class="me-2" style="width: 16px; height: 16px;"></i>
                                        Existing Variants ({{ component.variants|length }})
                                    </h6>
                                    
                                    <div class="row">
                                        {% for variant in component.variants %}
                                        <div class="col-md-6 col-lg-4 mb-3">
                                            <div class="variant-card">
                                                <div class="variant-header">
                                                    <div class="variant-color-indicator" 
                                                         style="background-color: {{ variant.color.hex_code if hasattr(variant.color, 'hex_code') and variant.color.hex_code else '#ccc' }};"
                                                         title="{{ variant.color.name }}"></div>
                                                    <div class="variant-info">
                                                        <h6 class="mb-1">{{ variant.get_display_name() }}</h6>
                                                        <small class="text-muted">{{ variant.color.name }}</small>
                                                    </div>
                                                    <div class="variant-actions">
                                                        <a href="{{ url_for('main.edit_variant', component_id=component.id, variant_id=variant.id) }}"
                                                           class="btn btn-sm btn-outline-primary"
                                                           title="Edit variant">
                                                            <i data-lucide="edit" style="width: 14px; height: 14px;"></i>
                                                        </a>
                                                        <button type="button"
                                                                class="btn btn-sm btn-outline-danger"
                                                                onclick="deleteVariant({{ variant.id }})"
                                                                title="Delete variant">
                                                            <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                
                                                <div class="variant-images">
                                                    {% if variant.variant_pictures %}
                                                    <div class="variant-image-preview">
                                                        {% for picture in variant.variant_pictures[:3] %}
                                                        <img src="{{ picture.url }}" 
                                                             alt="{{ picture.picture_name }}"
                                                             class="variant-thumbnail"
                                                             title="{{ picture.picture_name }}">
                                                        {% endfor %}
                                                        {% if variant.variant_pictures|length > 3 %}
                                                        <div class="variant-thumbnail-more">
                                                            <span>+{{ variant.variant_pictures|length - 3 }}</span>
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                    <small class="text-muted">{{ variant.variant_pictures|length }} image{{ 's' if variant.variant_pictures|length != 1 else '' }}</small>
                                                    {% else %}
                                                    <div class="variant-no-images">
                                                        <i data-lucide="image" style="width: 24px; height: 24px; color: #ccc;"></i>
                                                        <small class="text-muted">No images</small>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                                
                                                {% if variant.description %}
                                                <div class="variant-description">
                                                    <small class="text-muted">{{ variant.description }}</small>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Add New Variant Section -->
                                <div class="form-section">
                                    <h6 class="fw-bold mb-3">
                                        <i data-lucide="plus" class="me-2" style="width: 16px; height: 16px;"></i>
                                        Add New Variant
                                    </h6>
                                    
                                    <div class="alert alert-modern alert-info">
                                        <div class="d-flex align-items-center">
                                            <i data-lucide="info" class="me-2" style="width: 20px; height: 20px;"></i>
                                            <div>
                                                <strong>New variants are managed separately</strong>
                                                <p class="mb-0 mt-1">Click the button below to add a new color variant. You'll be taken to a dedicated form where you can set the color, name, description, and upload variant-specific images.</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex gap-2">
                                        <a href="{{ url_for('main.new_variant', id=component.id) if component else '#' }}"
                                           class="btn btn-primary-modern btn-modern"
                                           {% if not component %}disabled{% endif %}>
                                            <i data-lucide="plus" class="me-2" style="width: 16px; height: 16px;"></i>
                                            Add New Variant
                                        </a>
                                        
                                        {% if component and component.variants %}
                                        <a href="{{ url_for('main.component_detail', id=component.id) }}"
                                           class="btn btn-outline-secondary">
                                            <i data-lucide="eye" class="me-2" style="width: 16px; height: 16px;"></i>
                                            View All Variants
                                        </a>
                                        {% endif %}
                                    </div>
                                    
                                    {% if not component %}
                                    <div class="mt-3">
                                        <small class="text-muted">
                                            <i data-lucide="info" style="width: 14px; height: 14px;"></i>
                                            Save the component first to add variants
                                        </small>
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Variant Management Tips -->
                                <div class="form-section">
                                    <h6 class="fw-bold mb-3">
                                        <i data-lucide="lightbulb" class="me-2" style="width: 16px; height: 16px;"></i>
                                        Tips for Managing Variants
                                    </h6>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <ul class="list-unstyled">
                                                <li class="mb-2">
                                                    <i data-lucide="check-circle" style="width: 16px; height: 16px; color: var(--color-success);"></i>
                                                    <small class="ms-2">Each variant can have multiple images</small>
                                                </li>
                                                <li class="mb-2">
                                                    <i data-lucide="check-circle" style="width: 16px; height: 16px; color: var(--color-success);"></i>
                                                    <small class="ms-2">Images are ordered for display</small>
                                                </li>
                                                <li class="mb-2">
                                                    <i data-lucide="check-circle" style="width: 16px; height: 16px; color: var(--color-success);"></i>
                                                    <small class="ms-2">Variants can have custom names</small>
                                                </li>
                                            </ul>
                                        </div>
                                        <div class="col-md-6">
                                            <ul class="list-unstyled">
                                                <li class="mb-2">
                                                    <i data-lucide="check-circle" style="width: 16px; height: 16px; color: var(--color-success);"></i>
                                                    <small class="ms-2">Each color can only be used once</small>
                                                </li>
                                                <li class="mb-2">
                                                    <i data-lucide="check-circle" style="width: 16px; height: 16px; color: var(--color-success);"></i>
                                                    <small class="ms-2">Variants can be activated/deactivated</small>
                                                </li>
                                                <li class="mb-2">
                                                    <i data-lucide="check-circle" style="width: 16px; height: 16px; color: var(--color-success);"></i>
                                                    <small class="ms-2">Images are automatically optimized</small>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Wizard Navigation -->
                    <div class="wizard-navigation">
                        <button type="button"
                                class="btn btn-outline-secondary"
                                @click="previousStep()"
                                :disabled="currentStep === 1">
                            <i data-lucide="arrow-left" class="me-2" style="width: 16px; height: 16px;"></i>
                            Previous
                        </button>

                        <div class="d-flex align-items-center gap-3">
                            <span class="text-muted">
                                Step <span x-text="currentStep"></span> of <span x-text="totalSteps"></span>
                            </span>

                            <button type="button"
                                    class="btn btn-primary-modern btn-modern"
                                    @click="nextStep()"
                                    x-show="currentStep < totalSteps"
                                    :disabled="!isStepValid(currentStep)">
                                Next
                                <i data-lucide="arrow-right" class="ms-2" style="width: 16px; height: 16px;"></i>
                            </button>

                            <button type="submit"
                                    class="btn btn-success-modern btn-modern"
                                    x-show="currentStep === totalSteps"
                                    :disabled="!isFormValid() || isSubmitting"
                                    :class="{ 'loading': isSubmitting }">
                                <span x-show="!isSubmitting">
                                    <i data-lucide="save" class="me-2" style="width: 16px; height: 16px;"></i>
                                    {{ 'Update Component' if component else 'Save Component' }}
                                </span>
                                <span x-show="isSubmitting" class="d-flex align-items-center">
                                    <span class="spinner me-2"></span>
                                    Saving...
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Live Preview Sidebar -->
        <div class="col-lg-4">
            <div class="live-preview">
                <h5 class="fw-bold mb-3">
                    <i data-lucide="eye" class="me-2" style="width: 20px; height: 20px;"></i>
                    Live Preview
                </h5>

                <div class="preview-card">
                    <!-- Preview Image -->
                    <div class="preview-image-area" x-show="!images.length">
                        <div class="text-center">
                            <i data-lucide="image" style="width: 48px; height: 48px;"></i>
                            <p class="mt-2 mb-0">No image</p>
                        </div>
                    </div>
                    <img :src="images[0]?.url"
                         x-show="images.length > 0"
                         style="width: 100%; height: 150px; object-fit: cover;">

                    <!-- Preview Content -->
                    <div class="preview-content">
                        <h6 class="mb-2" x-text="formData.product_number || 'Product Number'"></h6>
                        <p class="text-muted small mb-2" x-text="formData.description || 'Component description will appear here...'"></p>

                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="badge bg-primary" x-text="getSelectedText('component_type_id') || 'Type'"></span>
                            <small class="text-muted" x-text="getSelectedText('supplier_id') || 'Supplier'"></small>
                        </div>

                        <div class="mb-2">
                            <small class="text-muted">
                                <i data-lucide="folder" style="width: 12px; height: 12px;"></i>
                                <span x-text="getSelectedText('category_id') || 'Category'"></span>
                            </small>
                        </div>

                        <!-- Preview Brands -->
                        <div x-show="selectedBrands.length > 0" class="mb-2">
                            <small class="text-muted fw-semibold">Brands:</small><br>
                            <div class="d-flex flex-wrap gap-1">
                                <template x-for="brand in selectedBrands.slice(0, 3)" :key="brand.id">
                                    <span class="badge bg-primary" style="font-size: 0.7rem;" x-text="brand.name"></span>
                                </template>
                                <span x-show="selectedBrands.length > 3" class="badge bg-secondary" style="font-size: 0.7rem;">
                                    +<span x-text="selectedBrands.length - 3"></span>
                                </span>
                            </div>
                        </div>

                        <!-- Preview Keywords -->
                        <div x-show="keywords.length > 0">
                            <div class="d-flex flex-wrap gap-1">
                                <template x-for="keyword in keywords.slice(0, 3)" :key="keyword">
                                    <span class="badge bg-secondary" style="font-size: 0.7rem;" x-text="keyword"></span>
                                </template>
                                <span x-show="keywords.length > 3" class="badge bg-light text-dark" style="font-size: 0.7rem;">
                                    +<span x-text="keywords.length - 3"></span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Auto-save Status -->
                <div class="mt-3 p-2 bg-light rounded text-center">
                    <small class="text-muted">
                        <i data-lucide="save" style="width: 14px; height: 14px;"></i>
                        <span x-text="lastSaved ? 'Last saved: ' + lastSaved : 'No changes yet'"></span>
                    </small>
                </div>

                <!-- Validation Summary -->
                <div x-show="Object.keys(errors).length > 0" class="mt-3 p-2 bg-danger bg-opacity-10 rounded">
                    <small class="text-danger fw-bold">
                        <i data-lucide="alert-triangle" style="width: 14px; height: 14px;"></i>
                        <span x-text="Object.keys(errors).length"></span> validation error(s)
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Auto-save Indicator -->
    <div class="auto-save-indicator" :class="{ 'show': showAutoSaveIndicator }">
        <i data-lucide="check-circle" style="width: 16px; height: 16px;"></i>
        <span>Auto-saved</span>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
// Parse backend-provided component_type_properties JSON once
const typeProperties = JSON.parse('{{ component_type_properties | tojson | safe }}');
const initialKeywords = {% if component and component.keywords %}{{ (component.keywords | map(attribute='name') | list) | tojson }}{% else %}[]{% endif %};
const initialSelectedBrands = {% if component_brands_json is defined %}{{ component_brands_json | tojson }}{% else %}[]{% endif %};
const initialAvailableBrands = {% if available_brands_json is defined %}{{ available_brands_json | tojson }}{% else %}[]{% endif %};
const initialProductNumber = {{ component.product_number | tojson if component and component.product_number is not none else '""' }};
const initialDescription = {{ component.description | tojson if component and component.description is not none else '""' }};
const initialComponentTypeId = {{ component.component_type_id | tojson if component and component.component_type_id is not none else '""' }};
const initialSupplierId = {{ component.supplier_id | tojson if component and component.supplier_id is not none else '""' }};
const initialCategoryId = {{ component.category_id | tojson if component and component.category_id is not none else '""' }};
const initialProperties = {% if component and component.properties is not none %}{{ component.properties | tojson }}{% else %}{}{% endif %};

function componentForm() {
    return {
        currentStep: 1,
        totalSteps: 6,
        dragOver: false,
        keywordInput: '',
        keywords: initialKeywords,
        keywordSuggestions: [],
        images: [],
        lastSaved: null,
        showAutoSaveIndicator: false,
        isSubmitting: false,
        errors: {},

        // Brand selection using serializable data passed from route
        selectedBrands: initialSelectedBrands,
        selectedBrandId: '',
        availableBrands: initialAvailableBrands,

        formData: {
            product_number: initialProductNumber,
            description: initialDescription,
            component_type_id: initialComponentTypeId,
            supplier_id: initialSupplierId,
            category_id: initialCategoryId,
            properties: initialProperties
        },

        availableProperties: [],
        propertyTypes: {
            'material': 'select',
            'color': 'select',
            'gender': 'multiselect',
            'style': 'multiselect',
            'subbrand': 'multiselect',
            'size': 'text',
            'finish': 'text',
            'weight': 'text',
            'subcategory': 'text'
        },

        propertyOptions: {
            'material': {% if materials %}{{ materials | map(attribute='name') | list | tojson }}{% else %}[]{% endif %},
            'color': {% if colors %}{{ colors | map(attribute='name') | list | tojson }}{% else %}[]{% endif %},
            'gender': ['ladies', 'men', 'unisex', 'all', 'kids'],
            'style': ['casual', 'formal', 'sport', 'winter', 'summer', 'vintage'],
            'subbrand': ['MAR Sport', 'MAR Classic', 'MMC Pro', 'MMC Casual', 'UBL Premium', 'UBL Basic']
        },

        propertyPlaceholders: {
            'size': 'e.g., 12mm, 15mm',
            'weight': 'e.g., 50g',
            'finish': 'e.g., matte, glossy'
        },

        init() {
            // Debug logging
            console.log('Component data:', {% if component %}true{% else %}false{% endif %});
            console.log('Selected brands:', this.selectedBrands);
            console.log('Available brands:', this.availableBrands);

            // Load component type properties if editing
            if (this.formData.component_type_id) {
                this.loadComponentTypeProperties();
            }

            // Initialize form validation
            this.validateForm();

            // FIXED: Ensure data is always arrays with proper structure
            if (!Array.isArray(this.selectedBrands)) {
                this.selectedBrands = [];
            }

            if (!Array.isArray(this.availableBrands)) {
                this.availableBrands = [];
            }

            // Ensure all brand objects have required properties
            this.selectedBrands = this.selectedBrands.map(brand => ({
                id: brand.id || brand.brand_id,
                name: brand.name || 'Unknown Brand'
            }));

            this.availableBrands = this.availableBrands.map(brand => ({
                id: brand.id,
                name: brand.name || 'Unknown Brand'
            }));
        },

        loadComponentTypeProperties() {
            const componentTypeSelect = document.getElementById('component_type_id');
            const selectedText = componentTypeSelect?.options[componentTypeSelect.selectedIndex]?.text;
            if (selectedText && typeProperties[selectedText]) {
                this.availableProperties = typeProperties[selectedText].map(p => p.property_name);
                this.availableProperties.forEach(prop => {
                    if (!(prop in this.formData.properties)) {
                        this.formData.properties[prop] = '';
                    }
                });
            } else {
                this.availableProperties = [];
            }
        },

        // FIXED: Brand management methods
        addBrand() {
            if (this.selectedBrandId) {
                const brand = this.availableBrands.find(b => b.id == this.selectedBrandId);
                if (brand && !this.selectedBrands.find(b => b.id == brand.id)) {
                    this.selectedBrands.push({
                        id: brand.id,
                        name: brand.name
                    });
                    this.selectedBrandId = '';
                    this.autoSave();
                }
            }
        },

        removeBrand(index) {
            if (index >= 0 && index < this.selectedBrands.length) {
                this.selectedBrands.splice(index, 1);
                this.autoSave();
            }
        },

        // Rest of the methods remain the same...
        nextStep() {
            if (this.isStepValid(this.currentStep) && this.currentStep < this.totalSteps) {
                this.currentStep++;
            }
        },

        previousStep() {
            if (this.currentStep > 1) {
                this.currentStep--;
            }
        },

        isStepValid(step) {
            switch(step) {
                case 1:
                    return this.formData.product_number &&
                           this.formData.component_type_id &&
                           this.formData.supplier_id &&
                           this.formData.category_id &&
                           Object.keys(this.errors).length === 0;
                case 2:
                    return true; // Brands are optional
                case 3:
                    return true; // Properties are optional
                case 4:
                    return true; // Images are optional
                case 5:
                    return true; // Keywords are optional
                case 6:
                    return true; // Variants are optional
                default:
                    return true;
            }
        },

        validateField(fieldName) {
            delete this.errors[fieldName];

            switch(fieldName) {
                case 'product_number':
                    if (!this.formData.product_number) {
                        this.errors.product_number = 'Product number is required';
                    } else if (this.formData.product_number.length < 3) {
                        this.errors.product_number = 'Product number must be at least 3 characters';
                    }
                    break;
                case 'component_type_id':
                    if (!this.formData.component_type_id) {
                        this.errors.component_type_id = 'Component type is required';
                    }
                    break;
                case 'supplier_id':
                    if (!this.formData.supplier_id) {
                        this.errors.supplier_id = 'Supplier is required';
                    }
                    break;
                case 'category_id':
                    if (!this.formData.category_id) {
                        this.errors.category_id = 'Category is required';
                    }
                    break;
            }
        },

        validateForm() {
            this.validateField('product_number');
            this.validateField('component_type_id');
            this.validateField('supplier_id');
            this.validateField('category_id');
            return Object.keys(this.errors).length === 0;
        },

        isFormValid() {
            return this.isStepValid(1);
        },

        handleImageSelect(event) {
            const files = event.target.files;
            this.processImages(files);
        },

        handleImageDrop(event) {
            this.dragOver = false;
            const files = event.dataTransfer.files;
            this.processImages(files);
        },

        processImages(files) {
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.images.push({
                            id: Date.now() + Math.random(),
                            file: file,
                            name: file.name,
                            url: e.target.result,
                            order: this.images.length + 1
                        });
                    };
                    reader.readAsDataURL(file);
                }
            });
        },

        removeImage(index) {
            this.images.splice(index, 1);
            this.images.forEach((img, i) => {
                img.order = i + 1;
            });
        },

        updateImageName(index, name) {
            if (this.images[index]) {
                this.images[index].name = name;
            }
        },

        updateImageOrder(index, order) {
            if (this.images[index]) {
                this.images[index].order = parseInt(order) || 1;
            }
        },

        searchKeywords() {
            const input = this.keywordInput.toLowerCase();
            if (input.length > 1) {
                const allKeywords = ['polyester', 'cotton', 'silk', 'wool', 'synthetic',
                                   'organic', 'sustainable', 'waterproof', 'breathable',
                                   'stretch', 'durable', 'lightweight', 'heavyweight',
                                   'luxury', 'sport', 'casual', 'formal', 'outdoor'];

                this.keywordSuggestions = allKeywords
                    .filter(kw => kw.includes(input) && !this.keywords.includes(kw))
                    .slice(0, 5);
            } else {
                this.keywordSuggestions = [];
            }
        },

        addKeyword() {
            const keyword = this.keywordInput.trim().toLowerCase();
            if (keyword && !this.keywords.includes(keyword)) {
                this.keywords.push(keyword);
                this.keywordInput = '';
                this.keywordSuggestions = [];
                this.autoSave();
            }
        },

        addKeywordFromSuggestion(suggestion) {
            if (suggestion && !this.keywords.includes(suggestion)) {
                this.keywords.push(suggestion);
                this.keywordInput = '';
                this.keywordSuggestions = [];
                this.autoSave();
            }
        },

        removeKeyword(index) {
            this.keywords.splice(index, 1);
            this.autoSave();
        },

        autoSave() {
            // Only auto-save if editing existing component
            {% if component %}
            clearTimeout(this.autoSaveTimeout);
            this.autoSaveTimeout = setTimeout(() => {
                this.lastSaved = new Date().toLocaleTimeString();
                this.showAutoSaveIndicator = true;
                setTimeout(() => {
                    this.showAutoSaveIndicator = false;
                }, 2000);
            }, 1000);
            {% endif %}
        },

        handleSubmit(event) {
            if (!this.isFormValid()) {
                event.preventDefault();
                alert('Please fill in all required fields before submitting.');
                return;
            }

            this.isSubmitting = true;

            // Add images to form data
            this.images.forEach((image, index) => {
                const input = document.createElement('input');
                input.type = 'file';
                input.name = `picture_${index + 1}`;
                input.files = this.createFileList(image.file);
                this.$refs.mainForm.appendChild(input);
            });
        },

        getSelectedText(selectName) {
            const select = document.getElementById(selectName);
            return select?.options[select.selectedIndex]?.text || '';
        },

        capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        },

        createFileList(file) {
            const dt = new DataTransfer();
            dt.items.add(file);
            return dt.files;
        }
    }
}
    // Initialize Lucide icons and other UI components
    document.addEventListener('DOMContentLoaded', function() {
        lucide.createIcons();

        // Initialize tooltips if using Bootstrap
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Auto-hide alerts after 5 seconds
        setTimeout(() => {
            const alerts = document.querySelectorAll('.alert-dismissible');
            alerts.forEach(alert => {
                const closeBtn = alert.querySelector('.btn-close');
                if (closeBtn) closeBtn.click();
            });
        }, 5000);
    });

    // Variant deletion function
    function deleteVariant(variantId) {
        if (confirm('Are you sure you want to delete this variant? This action cannot be undone.')) {
            // Create a form to submit the deletion
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/component/{{ component.id if component else '' }}/variant/${variantId}/delete`;
            
            // Add CSRF token if available
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            if (csrfToken) {
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrf_token';
                csrfInput.value = csrfToken;
                form.appendChild(csrfInput);
            }
            
            document.body.appendChild(form);
            form.submit();
        }
    }
</script>
{% endblock %}