{% extends "base.html" %}

{% block title %}{{ 'Edit Component' if component else 'New Component' }} - ComponentHub{% endblock %}

{% block extra_css %}
<style>
/* Modern CSS Custom Properties */
:root {
    --primary-color: #3b82f6;
    --primary-hover: #2563eb;
    --success-color: #10b981;
    --warning-color: #f59e0b;
    --danger-color: #ef4444;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-400: #9ca3af;
    --gray-500: #6b7280;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --gray-900: #111827;
    --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    --radius-sm: 0.375rem;
    --radius-md: 0.5rem;
    --radius-lg: 0.75rem;
    --spacing-xs: 0.5rem;
    --spacing-sm: 0.75rem;
    --spacing-md: 1rem;
    --spacing-lg: 1.5rem;
    --spacing-xl: 2rem;
}

/* Reset and Base Styles */
* {
    box-sizing: border-box;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    line-height: 1.6;
    color: var(--gray-800);
}

/* Layout Grid */
.component-form-layout {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--spacing-lg);
    max-width: 1400px;
    margin: 0 auto;
    padding: var(--spacing-md);
}

@media (min-width: 1024px) {
    .component-form-layout {
        grid-template-columns: 2fr 1fr;
        padding: var(--spacing-xl);
    }
}

/* Header Section */
.page-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
    color: white;
    padding: var(--spacing-xl);
    border-radius: var(--radius-lg);
    margin-bottom: var(--spacing-lg);
}

.page-header h1 {
    margin: 0 0 var(--spacing-sm) 0;
    font-size: 2rem;
    font-weight: 700;
}

.page-header p {
    margin: 0;
    opacity: 0.9;
}

.header-actions {
    margin-top: var(--spacing-md);
}

/* Modern Cards */
.form-card {
    background: white;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
    padding: var(--spacing-xl);
    margin-bottom: var(--spacing-lg);
    border: 1px solid var(--gray-200);
}

.form-card-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-lg);
    padding-bottom: var(--spacing-md);
    border-bottom: 2px solid var(--gray-100);
}

.form-card-icon {
    width: 24px;
    height: 24px;
    color: var(--primary-color);
}

.form-card-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
    color: var(--gray-900);
}

/* Form Elements */
.form-grid {
    display: grid;
    gap: var(--spacing-lg);
}

@media (min-width: 768px) {
    .form-grid-cols-2 {
        grid-template-columns: 1fr 1fr;
    }
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
}

.form-label {
    font-weight: 600;
    color: var(--gray-700);
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.form-label.required::after {
    content: " *";
    color: var(--danger-color);
}

.form-input,
.form-select,
.form-textarea {
    padding: var(--spacing-sm) var(--spacing-md);
    border: 2px solid var(--gray-200);
    border-radius: var(--radius-md);
    font-size: 1rem;
    transition: all 0.2s ease;
    background: white;
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgb(59 130 246 / 0.1);
}

.form-input.error,
.form-select.error,
.form-textarea.error {
    border-color: var(--danger-color);
}

.form-help {
    font-size: 0.875rem;
    color: var(--gray-500);
}

.form-error {
    font-size: 0.875rem;
    color: var(--danger-color);
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
}

/* Multi-Select Tags */
.tags-container {
    border: 2px solid var(--gray-200);
    border-radius: var(--radius-md);
    padding: var(--spacing-sm);
    min-height: 48px;
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-xs);
    align-items: center;
    background: white;
    transition: border-color 0.2s ease;
}

.tags-container:focus-within {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgb(59 130 246 / 0.1);
}

.tag {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-xs);
    background: var(--primary-color);
    color: white;
    padding: 0.25rem var(--spacing-sm);
    border-radius: var(--radius-sm);
    font-size: 0.875rem;
    font-weight: 500;
}

.tag-remove {
    cursor: pointer;
    padding: 0.125rem;
    border-radius: 50%;
    transition: background-color 0.2s ease;
}

.tag-remove:hover {
    background-color: rgba(255, 255, 255, 0.2);
}

/* Image Upload */
.image-upload-zone {
    border: 2px dashed var(--gray-300);
    border-radius: var(--radius-lg);
    padding: var(--spacing-xl);
    text-align: center;
    background: var(--gray-50);
    transition: all 0.3s ease;
    cursor: pointer;
}

.image-upload-zone:hover,
.image-upload-zone.dragover {
    border-color: var(--primary-color);
    background: rgb(59 130 246 / 0.05);
    transform: translateY(-2px);
}

.image-upload-icon {
    width: 48px;
    height: 48px;
    color: var(--gray-400);
    margin: 0 auto var(--spacing-md);
}

.image-preview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: var(--spacing-md);
    margin-top: var(--spacing-lg);
}

.image-preview-item {
    position: relative;
    border-radius: var(--radius-md);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
    background: white;
    border: 1px solid var(--gray-200);
}

.image-preview-img {
    width: 100%;
    height: 120px;
    object-fit: cover;
}

.image-preview-actions {
    position: absolute;
    top: var(--spacing-xs);
    right: var(--spacing-xs);
    display: flex;
    gap: var(--spacing-xs);
}

.image-action-btn {
    width: 24px;
    height: 24px;
    border: none;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s ease;
}

.image-action-btn:hover {
    background: rgba(0, 0, 0, 0.9);
}

/* Sidebar */
.sidebar {
    position: sticky;
    top: var(--spacing-lg);
    height: fit-content;
}

.preview-card {
    background: white;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
    overflow: hidden;
    border: 1px solid var(--gray-200);
}

.preview-image {
    width: 100%;
    height: 200px;
    background: var(--gray-100);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--gray-400);
}

.preview-content {
    padding: var(--spacing-lg);
}

.preview-title {
    font-size: 1.125rem;
    font-weight: 600;
    margin: 0 0 var(--spacing-sm) 0;
    color: var(--gray-900);
}

.preview-meta {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-xs);
    margin-bottom: var(--spacing-md);
}

.preview-badge {
    background: var(--primary-color);
    color: white;
    padding: 0.25rem var(--spacing-sm);
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    font-weight: 500;
}

/* Buttons */
.btn {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-xs);
    padding: var(--spacing-sm) var(--spacing-lg);
    border: none;
    border-radius: var(--radius-md);
    font-weight: 600;
    font-size: 0.875rem;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.2s ease;
    line-height: 1.5;
}

.btn-primary {
    background: var(--primary-color);
    color: white;
}

.btn-primary:hover {
    background: var(--primary-hover);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.btn-secondary {
    background: var(--gray-100);
    color: var(--gray-700);
    border: 1px solid var(--gray-300);
}

.btn-secondary:hover {
    background: var(--gray-200);
}

.btn-danger {
    background: var(--danger-color);
    color: white;
}

.btn-danger:hover {
    background: #dc2626;
}

/* Action Bar */
.action-bar {
    position: sticky;
    bottom: 0;
    background: white;
    border-top: 1px solid var(--gray-200);
    padding: var(--spacing-lg);
    margin: var(--spacing-lg) calc(-1 * var(--spacing-lg)) calc(-1 * var(--spacing-lg));
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: var(--spacing-md);
}

/* Validation States */
.validation-summary {
    background: #fef2f2;
    border: 1px solid #fecaca;
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
}

.validation-summary.hidden {
    display: none;
}

/* Loading States */
.loading {
    opacity: 0.6;
    pointer-events: none;
}

.spinner {
    width: 16px;
    height: 16px;
    border: 2px solid transparent;
    border-top: 2px solid currentColor;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Variant Management Styles */
.variant-card {
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-md);
    margin-bottom: var(--spacing-md);
    background: white;
}

.variant-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-md);
    background: var(--gray-50);
    border-bottom: 1px solid var(--gray-200);
    border-radius: var(--radius-md) var(--radius-md) 0 0;
}

.variant-title {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: var(--gray-800);
}

.variant-actions {
    display: flex;
    gap: var(--spacing-xs);
}

.variant-form {
    padding: var(--spacing-md);
}

.variant-pictures {
    border-top: 1px solid var(--gray-200);
    padding: var(--spacing-md);
    background: var(--gray-50);
}

.pictures-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-md);
}

.pictures-header h5 {
    margin: 0;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--gray-700);
}

.image-upload-area {
    margin-bottom: var(--spacing-md);
}

.upload-drop-zone {
    border: 2px dashed var(--gray-300);
    border-radius: var(--radius-md);
    padding: var(--spacing-lg);
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
}

.upload-drop-zone:hover {
    border-color: var(--primary-color);
    background: var(--gray-50);
}

.upload-drop-zone.dragover {
    border-color: var(--primary-color);
    background: #f0f9ff;
}

.upload-icon {
    width: 32px;
    height: 32px;
    color: var(--gray-400);
    margin-bottom: var(--spacing-xs);
}

.variant-pictures-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: var(--spacing-md);
}

.picture-item {
    position: relative;
    border-radius: var(--radius-md);
    overflow: hidden;
    background: white;
    border: 1px solid var(--gray-200);
}

.picture-item img {
    width: 100%;
    height: 120px;
    object-fit: cover;
}

.picture-overlay {
    position: absolute;
    top: var(--spacing-xs);
    right: var(--spacing-xs);
    display: flex;
    gap: var(--spacing-xs);
}

.picture-info {
    padding: var(--spacing-xs);
}

.picture-alt-input {
    width: 100%;
    padding: var(--spacing-xs);
    border: 1px solid var(--gray-300);
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    margin-bottom: var(--spacing-xs);
}

.primary-badge {
    background: var(--success-color);
    color: white;
    padding: 2px 6px;
    border-radius: var(--radius-sm);
    font-size: 0.625rem;
    font-weight: 600;
}

.empty-state {
    text-align: center;
    padding: var(--spacing-xl);
    color: var(--gray-500);
}

.empty-icon {
    width: 48px;
    height: 48px;
    margin-bottom: var(--spacing-md);
    opacity: 0.5;
}

.empty-state h3 {
    margin: 0 0 var(--spacing-sm) 0;
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--gray-700);
}

.empty-state p {
    margin: 0 0 var(--spacing-lg) 0;
}

/* Picture Miniatures */
.pictures-section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-sm);
}

.picture-miniatures {
    display: flex;
    gap: var(--spacing-xs);
    flex-wrap: wrap;
    align-items: center;
    min-height: 50px;
}

.miniature-item {
    position: relative;
    width: 70px;
    height: 50px;
    border-radius: var(--radius-sm);
    overflow: hidden;
    border: 2px solid var(--gray-300);
    cursor: pointer;
    transition: all 0.2s ease;
    background: white;
}

.miniature-item:hover {
    border-color: var(--primary-color);
    transform: scale(1.05);
}

.miniature-item:hover .miniature-actions {
    opacity: 1;
}

.miniature-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.miniature-order {
    position: absolute;
    bottom: 2px;
    left: 2px;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    font-size: 0.625rem;
    padding: 2px 4px;
    border-radius: 2px;
    font-weight: 600;
    line-height: 1;
}

.miniature-primary {
    position: absolute;
    top: 2px;
    right: 2px;
    background: var(--success-color);
    color: white;
    font-size: 0.625rem;
    padding: 2px 4px;
    border-radius: 2px;
    line-height: 1;
    font-weight: 600;
}

.miniature-actions {
    position: absolute;
    top: 2px;
    left: 2px;
    display: flex;
    gap: 2px;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.miniature-action-btn {
    width: 16px;
    height: 16px;
    border: none;
    border-radius: 2px;
    cursor: pointer;
    font-size: 0.625rem;
    font-weight: 600;
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.miniature-action-btn.delete {
    background: var(--danger-color);
    color: white;
}

.miniature-action-btn.delete:hover {
    background: #dc2626;
}

.miniature-action-btn.primary {
    background: var(--warning-color);
    color: white;
}

.miniature-action-btn.primary:hover {
    background: var(--success-color);
}

.no-pictures {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    color: var(--gray-400);
    font-style: italic;
    padding: var(--spacing-md);
    border: 2px dashed var(--gray-300);
    border-radius: var(--radius-sm);
    background: var(--gray-50);
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 200px;
    justify-content: center;
}

.no-pictures:hover {
    border-color: var(--primary-color);
    background: #f0f9ff;
    color: var(--primary-color);
}

.no-pictures svg {
    opacity: 0.5;
}

/* Responsive Design */
@media (max-width: 768px) {
    .component-form-layout {
        padding: var(--spacing-md);
    }
    
    .page-header {
        padding: var(--spacing-lg);
    }
    
    .variant-pictures-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: var(--spacing-sm);
    }
    
    .form-card {
        padding: var(--spacing-lg);
    }
    
    .action-bar {
        flex-direction: column;
        align-items: stretch;
    }
    
    .action-bar .btn {
        justify-content: center;
    }
}

/* Accessibility */
@media (prefers-reduced-motion: reduce) {
    * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

/* Remove progress-related styles */
.progress-item,
.status {
    display: none;
}

/* Highlight changed fields */
.field-changed {
    animation: highlightField 2s ease-in-out;
    border-color: var(--success-color) !important;
    box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1) !important;
}

@keyframes highlightField {
    0% {
        background-color: rgba(34, 197, 94, 0.1);
        transform: scale(1);
    }
    50% {
        background-color: rgba(34, 197, 94, 0.2);
        transform: scale(1.02);
    }
    100% {
        background-color: transparent;
        transform: scale(1);
    }
}

/* Success message styling */
.success-highlight {
    background: linear-gradient(135deg, #dcfce7, #bbf7d0);
    border: 1px solid #22c55e;
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
    color: #166534;
    font-weight: 500;
}

.success-highlight .highlight-list {
    margin-top: var(--spacing-sm);
    font-size: 0.875rem;
    color: #15803d;
}

.success-highlight .highlight-list ul {
    margin: 0;
    padding-left: var(--spacing-md);
}

.success-highlight .highlight-list li {
    margin-bottom: var(--spacing-xs);
}
</style>
{% endblock %}

{% block content %}
<div class="component-form-layout">
    <!-- Success Message for Changed Fields -->
    {% if changed_fields %}
    <div class="success-highlight">
        <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-sm);">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
            </svg>
            <strong>Component updated successfully!</strong>
        </div>
        <div class="highlight-list">
            <strong>Updated fields:</strong>
            <ul>
                {% for field in changed_fields %}
                <li>
                    {% if field == 'product_number' %}Product Number
                    {% elif field == 'description' %}Description
                    {% elif field == 'component_type_id' %}Component Type
                    {% elif field == 'supplier_id' %}Supplier
                    {% elif field == 'category_id' %}Category
                    {% elif field == 'keywords' %}Keywords
                    {% elif field == 'brands' %}Brands
                    {% elif field == 'properties' %}Properties
                    {% elif field == 'images' %}Images
                    {% else %}{{ field|title }}{% endif %}
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}

    <!-- Main Form Column -->
    <div class="main-form">
        <!-- Page Header -->
        <div class="page-header">
            <h1>{{ 'Edit Component' if component else 'Create New Component' }}</h1>
            <p>{{ 'Update component details and properties' if component else 'Add a new component to your library' }}</p>
            <div class="header-actions">
                <a href="{{ url_for('main.index') }}" class="btn btn-secondary">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                    </svg>
                    Back to Components
                </a>
            </div>
        </div>

        <!-- Validation Summary -->
        <div id="validationSummary" class="validation-summary hidden">
            <h4 style="margin: 0 0 0.5rem 0; color: var(--danger-color); font-size: 1rem;">Please fix the following errors:</h4>
            <ul id="validationList" style="margin: 0; padding-left: 1.25rem;"></ul>
        </div>

        <!-- Main Form -->
        <form id="componentForm" method="POST" enctype="multipart/form-data" novalidate>
            
            <!-- Essential Information -->
            <div class="form-card">
                <div class="form-card-header">
                    <svg class="form-card-icon" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
                        <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115l.094-.319z"/>
                    </svg>
                    <h2 class="form-card-title">Essential Information</h2>
                </div>

                <div class="form-grid form-grid-cols-2">
                    <div class="form-group">
                        <label for="product_number" class="form-label required">Product Number</label>
                        <input 
                            type="text" 
                            id="product_number" 
                            name="product_number" 
                            class="form-input"
                            value="{{ component.product_number if component else '' }}"
                            required
                            aria-describedby="product_number_help product_number_error"
                        >
                        <div id="product_number_help" class="form-help">Unique identifier (e.g., F-WL001, S-WL0001)</div>
                        <div id="product_number_error" class="form-error hidden"></div>
                    </div>

                    <div class="form-group">
                        <label for="component_type_id" class="form-label required">Component Type</label>
                        <select 
                            id="component_type_id" 
                            name="component_type_id" 
                            class="form-select"
                            required
                            aria-describedby="component_type_error"
                        >
                            <option value="">Select component type...</option>
                            {% for component_type in component_types %}
                            <option value="{{ component_type.id }}" 
                                    {% if component and component.component_type_id == component_type.id %}selected{% endif %}>
                                {{ component_type.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <div id="component_type_error" class="form-error hidden"></div>
                    </div>

                    <div class="form-group">
                        <label for="supplier_id" class="form-label required">Supplier</label>
                        <select 
                            id="supplier_id" 
                            name="supplier_id" 
                            class="form-select"
                            required
                            aria-describedby="supplier_error"
                        >
                            <option value="">Select supplier...</option>
                            {% for supplier in suppliers %}
                            <option value="{{ supplier.id }}" 
                                    {% if component and component.supplier_id == supplier.id %}selected{% endif %}>
                                {{ supplier.supplier_code }}
                            </option>
                            {% endfor %}
                        </select>
                        <div id="supplier_error" class="form-error hidden"></div>
                    </div>

                    <div class="form-group">
                        <label for="category_id" class="form-label required">Category</label>
                        <select 
                            id="category_id" 
                            name="category_id" 
                            class="form-select"
                            required
                            aria-describedby="category_error"
                        >
                            <option value="">Select category...</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}" 
                                    {% if component and component.category_id == category.id %}selected{% endif %}>
                                {{ category.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <div id="category_error" class="form-error hidden"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="description" class="form-label">Description</label>
                    <textarea 
                        id="description" 
                        name="description" 
                        class="form-textarea"
                        rows="4"
                        placeholder="Detailed description of the component..."
                        aria-describedby="description_help"
                    >{{ component.description if component else '' }}</textarea>
                    <div id="description_help" class="form-help">
                        <span id="char_count">{{ component.description|length if component and component.description else 0 }}</span> characters
                    </div>
                </div>
            </div>

            <!-- Brand Selection -->
            <div class="form-card">
                <div class="form-card-header">
                    <svg class="form-card-icon" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M2.97 1.35A1 1 0 0 1 3.73 1h8.54a1 1 0 0 1 .76.35l2.609 3.044A1.5 1.5 0 0 1 16 5.37v.255a2.375 2.375 0 0 1-4.25 1.458A2.371 2.371 0 0 1 9.875 8 2.37 2.37 0 0 1 8 7.083 2.37 2.37 0 0 1 6.125 8a2.37 2.37 0 0 1-1.875-.917A2.375 2.375 0 0 1 0 5.625V5.37a1.5 1.5 0 0 1 .361-.976l2.61-3.045zm1.78 4.275a1.375 1.375 0 0 0 2.75 0 .5.5 0 0 1 1 0 1.375 1.375 0 0 0 2.75 0 .5.5 0 0 1 1 0 1.375 1.375 0 1 0 2.75 0V5.37a.5.5 0 0 0-.12-.325L12.27 2H3.73L1.12 5.045A.5.5 0 0 0 1 5.37v.255a1.375 1.375 0 0 0 2.75 0 .5.5 0 0 1 1 0zM1.5 8.5A.5.5 0 0 1 2 9v6h1v-5a1 1 0 0 1 1-1h3a1 1 0 0 1 1 1v5h6V9a.5.5 0 0 1 1 0v6.5a.5.5 0 0 1-.5.5H.5a.5.5 0 0 1-.5-.5V9a.5.5 0 0 1 .5-.5z"/>
                    </svg>
                    <h2 class="form-card-title">Brand Association</h2>
                </div>

                <div class="form-group">
                    <label for="brand_select" class="form-label">Select Brands</label>
                    <select id="brand_select" class="form-select" aria-describedby="brand_help">
                        <option value="">Choose a brand to add...</option>
                        {% for brand in brands %}
                        <option value="{{ brand.id }}" data-name="{{ brand.name }}">{{ brand.name }}</option>
                        {% endfor %}
                    </select>
                    <div id="brand_help" class="form-help">You can associate this component with multiple brands</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Selected Brands</label>
                    <div id="selected_brands" class="tags-container" role="group" aria-label="Selected brands">
                        {% if component and component.brands %}
                            {% for brand in component.brands %}
                            <div class="tag" data-brand-id="{{ brand.id }}">
                                <span>{{ brand.name }}</span>
                                <button type="button" class="tag-remove" aria-label="Remove {{ brand.name }}">
                                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                                    </svg>
                                </button>
                                <input type="hidden" name="brands" value="{{ brand.id }}">
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Dynamic Properties -->
            <div class="form-card">
                <div class="form-card-header">
                    <svg class="form-card-icon" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z"/>
                    </svg>
                    <h2 class="form-card-title">Component Properties</h2>
                </div>

                <div id="properties_container" class="form-grid">
                    <div id="no_properties" class="text-center" style="grid-column: 1 / -1; padding: 2rem; color: var(--gray-500);">
                        <svg width="48" height="48" fill="currentColor" viewBox="0 0 16 16" style="margin-bottom: 1rem; opacity: 0.5;">
                            <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
                        </svg>
                        <p>Select a component type to see available properties</p>
                    </div>
                </div>
            </div>

            <!-- Component Variants -->
            <div class="form-card">
                <div class="form-card-header">
                    <svg class="form-card-icon" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
                        <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115l.094-.319z"/>
                    </svg>
                    <h2 class="form-card-title">Component Variants</h2>
                    <button type="button" class="btn btn-primary btn-sm" id="add_variant_btn">
                        <svg style="width: 16px; height: 16px;" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                        </svg>
                        Add Variant
                    </button>
                </div>

                <div id="variants_container">
                    {% if component and component.variants %}
                        {% for variant in component.variants %}
                        <div class="variant-card" data-variant-id="{{ variant.id }}">
                            <div class="variant-header">
                                <h4 class="variant-title">{{ variant.color.name }} - {{ variant.variant_sku or 'No SKU' }}</h4>
                                <div class="variant-actions">
                                    <button type="button" class="btn-icon btn-icon-outline" onclick="toggleVariantPictures({{ variant.id }})" title="Manage Pictures">
                                        <svg style="width: 16px; height: 16px;" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                                            <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/>
                                        </svg>
                                    </button>
                                    <button type="button" class="btn-icon btn-icon-danger" onclick="removeVariant({{ variant.id }})" title="Remove Variant">×</button>
                                </div>
                            </div>
                            
                            <div class="variant-form">
                                <div class="form-grid form-grid-cols-2">
                                    <div class="form-group">
                                        <label class="form-label required">Color</label>
                                        <select name="variant_color_{{ variant.id }}" class="form-select" required onchange="updateVariantSKU({{ variant.id }})">
                                            <option value="{{ variant.color_id }}" selected style="font-weight: 500;">
                                                {{ variant.color.name }} (Current)
                                            </option>
                                            <optgroup label="Available Colors">
                                                {% for color in colors %}
                                                    {% if color.id != variant.color_id %}
                                                    <option value="{{ color.id }}">
                                                        {{ color.name }}
                                                    </option>
                                                    {% endif %}
                                                {% endfor %}
                                            </optgroup>
                                        </select>
                                        <div class="form-help">Select a different color to change the variant</div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Variant SKU</label>
                                        <input 
                                            type="text" 
                                            name="variant_sku_{{ variant.id }}" 
                                            id="variant_sku_{{ variant.id }}"
                                            class="form-input"
                                            value="{{ variant.variant_sku }}"
                                            readonly
                                            style="background: var(--gray-50);"
                                            title="Current SKU from database">
                                        <div class="form-help">
                                            <span id="sku_help_{{ variant.id }}">Current SKU from database</span>
                                            <span id="sku_preview_{{ variant.id }}" class="text-muted" style="display: none;">
                                                Preview of new SKU (will be applied when saved)
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Picture Miniatures with Actions -->
                                <div class="form-group">
                                    <div class="pictures-section-header">
                                        <label class="form-label">Pictures ({{ variant.variant_pictures|length }})</label>
                                        <button type="button" class="btn btn-outline btn-sm" onclick="toggleVariantPictures({{ variant.id }})" title="Manage Pictures">
                                            <svg style="width: 14px; height: 14px;" fill="currentColor" viewBox="0 0 16 16">
                                                <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                                                <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/>
                                            </svg>
                                            Manage Pictures
                                        </button>
                                    </div>
                                    <div class="picture-miniatures" id="miniatures_display_{{ variant.id }}">
                                        {% if variant.variant_pictures %}
                                            {% for picture in variant.variant_pictures|sort(attribute='picture_order') %}
                                            <div class="miniature-item" data-picture-id="{{ picture.id }}" 
                                                 title="Order: {{ picture.picture_order }}{% if picture.is_primary %} - Primary{% endif %}"
                                                 onclick="editVariantPicture({{ variant.id }}, {{ picture.id }})">
                                                <img src="{{ picture.url }}" alt="{{ picture.alt_text or 'Variant image' }}">
                                                <span class="miniature-order">{{ picture.picture_order }}</span>
                                                {% if picture.is_primary %}
                                                <span class="miniature-primary">★</span>
                                                {% endif %}
                                                <div class="miniature-actions">
                                                    <button type="button" class="miniature-action-btn delete" 
                                                            onclick="event.stopPropagation(); deleteVariantPicture({{ variant.id }}, {{ picture.id }})"
                                                            title="Delete picture">×</button>
                                                    {% if not picture.is_primary %}
                                                    <button type="button" class="miniature-action-btn primary" 
                                                            onclick="event.stopPropagation(); setPrimaryVariantPicture({{ variant.id }}, {{ picture.id }})"
                                                            title="Set as primary">★</button>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% endfor %}
                                        {% else %}
                                        <div class="no-pictures" onclick="toggleVariantPictures({{ variant.id }})">
                                            <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                                                <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                                                <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/>
                                            </svg>
                                            <span>Click to add pictures</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Variant Pictures Section -->
                            <div class="variant-pictures" id="variant_pictures_{{ variant.id }}" style="display: none;">
                                <div class="pictures-header">
                                    <h5>Pictures for {{ variant.variant_name or variant.color.name }}</h5>
                                    <button type="button" class="btn btn-outline btn-sm" onclick="addVariantPicture({{ variant.id }})">
                                        Add Picture
                                    </button>
                                </div>
                                
                                <div class="image-upload-area" id="upload_area_{{ variant.id }}">
                                    <input type="file" id="variant_images_{{ variant.id }}" multiple accept="image/*" style="display: none;" onchange="handleVariantImages({{ variant.id }}, this.files)">
                                    <div class="upload-drop-zone" onclick="document.getElementById('variant_images_{{ variant.id }}').click()">
                                        <svg class="upload-icon" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M8.5 11.5a.5.5 0 0 1-1 0V7.707L6.354 8.854a.5.5 0 1 1-.708-.708l2-2a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 7.707V11.5z"/>
                                            <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
                                        </svg>
                                        <p>Drop images or click to upload</p>
                                    </div>
                                </div>
                                
                                <div class="variant-pictures-grid" id="pictures_grid_{{ variant.id }}">
                                    {% for picture in variant.variant_pictures %}
                                    <div class="picture-item" data-picture-id="{{ picture.id }}">
                                        <img src="{{ picture.url }}" alt="{{ picture.alt_text or 'Variant image' }}">
                                        <div class="picture-overlay">
                                            <button type="button" class="btn-icon btn-icon-danger" onclick="removeVariantPicture({{ variant.id }}, {{ picture.id }})">×</button>
                                            {% if picture.is_primary %}
                                            <span class="primary-badge">Primary</span>
                                            {% else %}
                                            <button type="button" class="btn-icon btn-icon-primary" onclick="setPrimaryVariantPicture({{ variant.id }}, {{ picture.id }})">★</button>
                                            {% endif %}
                                        </div>
                                        <div class="picture-info">
                                            <input type="text" 
                                                   name="picture_alt_{{ picture.id }}" 
                                                   value="{{ picture.alt_text or '' }}" 
                                                   placeholder="Alt text"
                                                   class="picture-alt-input">
                                            <small>Order: {{ picture.picture_order }}</small>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="empty-state" id="empty_variants">
                        <svg class="empty-icon" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
                        </svg>
                        <h3>No Variants Yet</h3>
                        <p>Add color variants to showcase different options for this component</p>
                        <button type="button" class="btn btn-primary" onclick="addNewVariant()">Add First Variant</button>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Keywords -->
            <div class="form-card">
                <div class="form-card-header">
                    <svg class="form-card-icon" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/>
                    </svg>
                    <h2 class="form-card-title">Keywords</h2>
                </div>

                <div class="form-group">
                    <label for="keyword_input" class="form-label">Add Keywords</label>
                    <input 
                        type="text" 
                        id="keyword_input" 
                        class="form-input"
                        placeholder="Type keywords and press Enter or comma to add..."
                        aria-describedby="keyword_help"
                    >
                    <div id="keyword_help" class="form-help">Press Enter, comma, or Tab to add keywords</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Selected Keywords</label>
                    <div id="keyword_tags" class="tags-container" role="group" aria-label="Selected keywords">
                        {% if component and component.keywords %}
                            {% for keyword in component.keywords %}
                            <div class="tag" data-keyword="{{ keyword.name }}">
                                <span>{{ keyword.name }}</span>
                                <button type="button" class="tag-remove" aria-label="Remove {{ keyword.name }}">
                                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                                    </svg>
                                </button>
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <input type="hidden" id="keywords_input" name="keywords" value="{{ component.keywords | map(attribute='name') | join(',') if component and component.keywords else '' }}">
                </div>
            </div>

            <!-- Action Bar -->
            <div class="action-bar">
                <div>
                    <span id="save_status" style="color: var(--gray-500); font-size: 0.875rem;"></span>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <a href="{{ url_for('main.index') }}" class="btn btn-secondary">Cancel</a>
                    <button type="submit" id="submit_btn" class="btn btn-primary">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H9.5a1 1 0 0 0-1 1v7.293l2.646-2.647a.5.5 0 0 1 .708.708l-3.5 3.5a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L7.5 9.293V2a2 2 0 0 1 2-2H14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h2.5a.5.5 0 0 1 0 1H2z"/>
                        </svg>
                        {{ 'Update Component' if component else 'Save Component' }}
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="preview-card">
            <div id="preview_image" class="preview-image">
                <svg width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                    <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/>
                </svg>
            </div>
            <div class="preview-content">
                <h3 id="preview_title" class="preview-title">{{ component.product_number if component else 'Component Preview' }}</h3>
                <p id="preview_description" style="color: var(--gray-600); margin-bottom: 1rem;">
                    {{ component.description if component and component.description else 'Description will appear here...' }}
                </p>
                <div id="preview_meta" class="preview-meta">
                    {% if component %}
                    <span class="preview-badge">{{ component.component_type.name }}</span>
                    <span class="preview-badge">{{ component.supplier.supplier_code }}</span>
                    <span class="preview-badge">{{ component.category.name }}</span>
                    {% endif %}
                </div>
                <div id="preview_brands" style="margin-top: 1rem;">
                    {% if component and component.brands %}
                    <small style="color: var(--gray-500); font-weight: 600;">Brands:</small><br>
                    {% for brand in component.brands %}
                    <span class="preview-badge" style="background: var(--gray-600); margin-top: 0.25rem;">{{ brand.name }}</span>
                    {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Component Type Properties Data (simplified approach)
    const componentTypeProperties = {
        {% for ct in component_types %}
        '{{ ct.id }}': {
            name: '{{ ct.name }}',
            properties: [
                // We'll load these dynamically via AJAX to avoid JSON serialization issues
            ]
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    };

    // Form Elements
    const form = document.getElementById('componentForm');
    const productNumberInput = document.getElementById('product_number');
    const componentTypeSelect = document.getElementById('component_type_id');
    const supplierSelect = document.getElementById('supplier_id');
    const categorySelect = document.getElementById('category_id');
    const descriptionTextarea = document.getElementById('description');
    const brandSelect = document.getElementById('brand_select');
    const selectedBrandsContainer = document.getElementById('selected_brands');
    const keywordInput = document.getElementById('keyword_input');
    const keywordTags = document.getElementById('keyword_tags');
    const keywordsHiddenInput = document.getElementById('keywords_input');
    const propertiesContainer = document.getElementById('properties_container');
    const noPropertiesMsg = document.getElementById('no_properties');
    const submitBtn = document.getElementById('submit_btn');
    const saveStatus = document.getElementById('save_status');
    const validationSummary = document.getElementById('validationSummary');
    const validationList = document.getElementById('validationList');

    // State
    let selectedBrands = new Set();
    let selectedKeywords = new Set();
    let validationErrors = {};

    // Initialize
    init();

    function init() {
        // Initialize existing brands
        document.querySelectorAll('#selected_brands .tag').forEach(tag => {
            selectedBrands.add(tag.dataset.brandId);
        });

        // Initialize existing keywords
        document.querySelectorAll('#keyword_tags .tag').forEach(tag => {
            selectedKeywords.add(tag.dataset.keyword);
        });

        // Initialize preview image with primary picture if editing existing component
        {% if component and component.pictures %}
            {% set primary_picture = component.pictures|selectattr('is_primary', 'eq', true)|first %}
            {% if primary_picture %}
                const previewImage = document.getElementById('preview_image');
                previewImage.innerHTML = '<img src="{{ primary_picture.url }}" style="width: 100%; height: 100%; object-fit: cover;">';
            {% endif %}
        {% endif %}

        // Highlight changed fields if any
        {% if changed_fields %}
            highlightChangedFields();
        {% endif %}

        // Set up event listeners
        setupEventListeners();
    }

    function highlightChangedFields() {
        const changedFields = {{ changed_fields|tojson }};
        
        changedFields.forEach(fieldName => {
            let element = null;
            
            // Map field names to element IDs
            switch(fieldName) {
                case 'product_number':
                    element = document.getElementById('product_number');
                    break;
                case 'description':
                    element = document.getElementById('description');
                    break;
                case 'component_type_id':
                    element = document.getElementById('component_type_id');
                    break;
                case 'supplier_id':
                    element = document.getElementById('supplier_id');
                    break;
                case 'category_id':
                    element = document.getElementById('category_id');
                    break;
                case 'keywords':
                    element = document.getElementById('keyword_tags');
                    break;
                case 'brands':
                    element = document.getElementById('selected_brands');
                    break;
                case 'properties':
                    element = document.getElementById('properties_container');
                    break;
                case 'images':
                    element = document.getElementById('image_preview_grid');
                    break;
            }
            
            if (element) {
                element.classList.add('field-changed');
                // Remove the highlight class after animation completes
                setTimeout(() => {
                    element.classList.remove('field-changed');
                }, 2000);
            }
        });
    }

    function setupEventListeners() {
        // Form validation
        productNumberInput.addEventListener('input', () => {
            validateField('product_number');
            updatePreview();
        });
        
        componentTypeSelect.addEventListener('change', () => {
            validateField('component_type_id');
            loadComponentTypeProperties(componentTypeSelect.value);
            updatePreview();
        });
        
        supplierSelect.addEventListener('change', () => {
            validateField('supplier_id');
            updatePreview();
        });
        
        categorySelect.addEventListener('change', () => {
            validateField('category_id');
            updatePreview();
        });

        descriptionTextarea.addEventListener('input', () => {
            updateCharacterCount();
            updatePreview();
        });

        // Brand selection
        brandSelect.addEventListener('change', addBrand);
        selectedBrandsContainer.addEventListener('click', handleBrandRemove);

        // Keyword management
        keywordInput.addEventListener('keydown', handleKeywordInput);
        keywordTags.addEventListener('click', handleKeywordRemove);

        // Form submission
        form.addEventListener('submit', handleSubmit);

        // Auto-save (for edit mode)
        {% if component %}
        let autoSaveTimeout;
        form.addEventListener('input', () => {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                saveStatus.textContent = 'Changes saved automatically';
                setTimeout(() => {
                    saveStatus.textContent = '';
                }, 2000);
            }, 1000);
        });
        {% endif %}
    }

    function validateField(fieldName) {
        const field = document.getElementById(fieldName);
        const errorElement = document.getElementById(fieldName + '_error');
        let isValid = true;
        let errorMessage = '';

        // Clear previous error
        field.classList.remove('error');
        errorElement.classList.add('hidden');
        delete validationErrors[fieldName];

        // Validate based on field
        switch(fieldName) {
            case 'product_number':
                if (!field.value.trim()) {
                    errorMessage = 'Product number is required';
                    isValid = false;
                } else if (field.value.trim().length < 3) {
                    errorMessage = 'Product number must be at least 3 characters';
                    isValid = false;
                }
                break;
            case 'component_type_id':
                if (!field.value) {
                    errorMessage = 'Component type is required';
                    isValid = false;
                }
                break;
            case 'supplier_id':
                if (!field.value) {
                    errorMessage = 'Supplier is required';
                    isValid = false;
                }
                break;
            case 'category_id':
                if (!field.value) {
                    errorMessage = 'Category is required';
                    isValid = false;
                }
                break;
        }

        if (!isValid) {
            field.classList.add('error');
            errorElement.textContent = errorMessage;
            errorElement.classList.remove('hidden');
            validationErrors[fieldName] = errorMessage;
        }

        updateValidationSummary();
        return isValid;
    }

    function updateValidationSummary() {
        const errorCount = Object.keys(validationErrors).length;
        
        if (errorCount > 0) {
            validationList.innerHTML = '';
            Object.values(validationErrors).forEach(error => {
                const li = document.createElement('li');
                li.textContent = error;
                validationList.appendChild(li);
            });
            validationSummary.classList.remove('hidden');
        } else {
            validationSummary.classList.add('hidden');
        }
    }

    function loadComponentTypeProperties(componentTypeId) {
        if (!componentTypeId) {
            propertiesContainer.innerHTML = '<div id="no_properties" class="text-center" style="grid-column: 1 / -1; padding: 2rem; color: var(--gray-500);"><p>Select a component type to see available properties</p></div>';
            return;
        }

        // Show loading
        propertiesContainer.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 2rem;"><div class="spinner" style="margin: 0 auto;"></div></div>';

        // Load properties via AJAX to avoid JSON serialization issues
        fetch(`/api/component-type/${componentTypeId}/properties`)
            .then(response => response.json())
            .then(properties => {
                renderProperties(properties);
            })
            .catch(() => {
                // Fallback to hardcoded properties if API fails
                renderProperties([]);
            });
    }

    function renderProperties(properties) {
        if (properties.length === 0) {
            propertiesContainer.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--gray-500);"><p>No specific properties for this component type</p></div>';
            return;
        }

        propertiesContainer.innerHTML = '';
        propertiesContainer.style.gridTemplateColumns = 'repeat(auto-fit, minmax(280px, 1fr))';

        properties.forEach(property => {
            const propertyDiv = createPropertyField(property);
            propertiesContainer.appendChild(propertyDiv);
        });
    }

    function createPropertyField(property) {
        const div = document.createElement('div');
        div.className = 'form-group';

        const label = document.createElement('label');
        label.className = 'form-label' + (property.is_required ? ' required' : '');
        label.textContent = property.display_name || property.property_name;
        label.setAttribute('for', property.property_name);

        const currentValue = getCurrentPropertyValue(property.property_name);

        let input;
        if (property.property_type === 'select') {
            input = document.createElement('select');
            input.className = 'form-select';
            
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = `Select ${property.property_name}...`;
            input.appendChild(defaultOption);

            (property.options || []).forEach(option => {
                const optionEl = document.createElement('option');
                optionEl.value = option;
                optionEl.textContent = option;
                if (currentValue === option) optionEl.selected = true;
                input.appendChild(optionEl);
            });
        } else if (property.property_type === 'multiselect') {
            input = document.createElement('select');
            input.className = 'form-select';
            input.multiple = true;
            input.style.minHeight = '100px';

            (property.options || []).forEach(option => {
                const optionEl = document.createElement('option');
                optionEl.value = option;
                optionEl.textContent = option;
                if (Array.isArray(currentValue) && currentValue.includes(option)) {
                    optionEl.selected = true;
                }
                input.appendChild(optionEl);
            });
        } else {
            input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-input';
            input.placeholder = property.placeholder || `Enter ${property.property_name}`;
            input.value = currentValue || '';
        }

        input.id = property.property_name;
        input.name = property.property_name;

        div.appendChild(label);
        div.appendChild(input);

        if (property.placeholder && property.property_type === 'text') {
            const help = document.createElement('div');
            help.className = 'form-help';
            help.textContent = property.placeholder;
            div.appendChild(help);
        }

        return div;
    }

    function getCurrentPropertyValue(propertyName) {
        {% if component and component.properties %}
        const properties = {{ component.properties | tojson | safe }};
        if (properties[propertyName]) {
            return typeof properties[propertyName] === 'object' ? properties[propertyName].value : properties[propertyName];
        }
        {% endif %}
        return '';
    }

    function addBrand() {
        const brandId = brandSelect.value;
        const brandName = brandSelect.options[brandSelect.selectedIndex].text;
        
        if (brandId && !selectedBrands.has(brandId)) {
            selectedBrands.add(brandId);
            
            const tag = createTag(brandName, brandId, 'brand');
            selectedBrandsContainer.appendChild(tag);
            
            brandSelect.value = '';
        }
    }

    function handleBrandRemove(e) {
        if (e.target.closest('.tag-remove')) {
            const tag = e.target.closest('.tag');
            const brandId = tag.dataset.brandId;
            selectedBrands.delete(brandId);
            tag.remove();
        }
    }

    function handleKeywordInput(e) {
        if (e.key === 'Enter' || e.key === ',' || e.key === 'Tab') {
            e.preventDefault();
            addKeyword();
        }
    }

    function addKeyword() {
        const keyword = keywordInput.value.trim().toLowerCase();
        if (keyword && !selectedKeywords.has(keyword)) {
            selectedKeywords.add(keyword);
            
            const tag = createTag(keyword, keyword, 'keyword');
            keywordTags.appendChild(tag);
            
            keywordInput.value = '';
            updateKeywordsInput();
        }
    }

    function handleKeywordRemove(e) {
        if (e.target.closest('.tag-remove')) {
            const tag = e.target.closest('.tag');
            const keyword = tag.dataset.keyword;
            selectedKeywords.delete(keyword);
            tag.remove();
            updateKeywordsInput();
        }
    }

    function createTag(text, value, type) {
        const tag = document.createElement('div');
        tag.className = 'tag';
        tag.dataset[type + (type === 'brand' ? 'Id' : '')] = value;
        
        const span = document.createElement('span');
        span.textContent = text;
        
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'tag-remove';
        removeBtn.setAttribute('aria-label', `Remove ${text}`);
        removeBtn.innerHTML = '<svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>';
        
        tag.appendChild(span);
        tag.appendChild(removeBtn);
        
        if (type === 'brand') {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'brands';
            hiddenInput.value = value;
            tag.appendChild(hiddenInput);
        }
        
        return tag;
    }

    function updateKeywordsInput() {
        keywordsHiddenInput.value = Array.from(selectedKeywords).join(',');
    }

    function updateCharacterCount() {
        const charCount = document.getElementById('char_count');
        charCount.textContent = descriptionTextarea.value.length;
    }

    function handleDragOver(e) {
        e.preventDefault();
        imageUploadZone.classList.add('dragover');
    }

    function handleDragLeave(e) {
        e.preventDefault();
        imageUploadZone.classList.remove('dragover');
    }

    function handleDrop(e) {
        e.preventDefault();
        imageUploadZone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        processImages(files);
    }

    function handleImageSelect(e) {
        const files = e.target.files;
        processImages(files);
    }

    function processImages(files) {
        Array.from(files).forEach(file => {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageObj = {
                        id: Date.now() + Math.random(),
                        file: file,
                        name: file.name,
                        url: e.target.result
                    };
                    uploadedImages.push(imageObj);
                    renderImagePreview(imageObj);
                };
                reader.readAsDataURL(file);
            }
        });
    }

    function renderImagePreview(imageObj) {
        const div = document.createElement('div');
        div.className = 'image-preview-item';
        div.dataset.imageId = imageObj.id;
        
        div.innerHTML = `
            <img src="${imageObj.url}" alt="${imageObj.name}" class="image-preview-img">
            <div class="image-preview-actions">
                <button type="button" class="image-action-btn" onclick="removeImage('${imageObj.id}')" title="Remove image">
                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                    </svg>
                </button>
            </div>
        `;
        
        imagePreviewGrid.appendChild(div);
        updatePreviewImage();
    }

    function removeImage(imageId) {
        uploadedImages = uploadedImages.filter(img => img.id != imageId);
        const previewItem = document.querySelector(`[data-image-id="${imageId}"]`);
        if (previewItem) previewItem.remove();
        updatePreviewImage();
    }

    function removeExistingImage(btn) {
        const item = btn.closest('.image-preview-item');
        item.style.opacity = '0.5';
        const hiddenInput = item.querySelector('input[name="existing_pictures"]');
        if (hiddenInput) {
            hiddenInput.name = 'remove_pictures';
        }
    }

    function updatePreview() {
        const previewTitle = document.getElementById('preview_title');
        const previewDescription = document.getElementById('preview_description');
        const previewMeta = document.getElementById('preview_meta');
        
        previewTitle.textContent = productNumberInput.value || 'Component Preview';
        previewDescription.textContent = descriptionTextarea.value || 'Description will appear here...';
        
        // Update meta badges
        const metaBadges = [];
        if (componentTypeSelect.value) {
            metaBadges.push(componentTypeSelect.options[componentTypeSelect.selectedIndex].text);
        }
        if (supplierSelect.value) {
            metaBadges.push(supplierSelect.options[supplierSelect.selectedIndex].text);
        }
        if (categorySelect.value) {
            metaBadges.push(categorySelect.options[categorySelect.selectedIndex].text);
        }
        
        previewMeta.innerHTML = metaBadges.map(badge => 
            `<span class="preview-badge">${badge}</span>`
        ).join('');
    }

    function updatePreviewImage() {
        const previewImage = document.getElementById('preview_image');
        if (uploadedImages.length > 0) {
            previewImage.innerHTML = `<img src="${uploadedImages[0].url}" style="width: 100%; height: 100%; object-fit: cover;">`;
        }
    }

    function handleSubmit(e) {
        // Validate required fields
        const isValid = ['product_number', 'component_type_id', 'supplier_id', 'category_id'].every(validateField);
        
        if (!isValid) {
            e.preventDefault();
            document.querySelector('.validation-summary').scrollIntoView({ behavior: 'smooth' });
            return;
        }

        // Show loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<div class="spinner"></div> Saving...';
    }

    // Variant Management Functions
    let variantCount = {{ component.variants|length if component and component.variants else 0 }};
    
    function addNewVariant() {
        const emptyState = document.getElementById('empty_variants');
        if (emptyState) {
            emptyState.style.display = 'none';
        }
        
        variantCount++;
        const variantId = `new_${variantCount}`;
        const container = document.getElementById('variants_container');
        
        const variantCard = document.createElement('div');
        variantCard.className = 'variant-card';
        variantCard.dataset.variantId = variantId;
        
        variantCard.innerHTML = `
            <div class="variant-header">
                <h4 class="variant-title">New Variant - No SKU</h4>
                <div class="variant-actions">
                    <button type="button" class="btn-icon btn-icon-outline" onclick="toggleVariantPictures('${variantId}')" title="Manage Pictures">
                        <svg style="width: 16px; height: 16px;" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                            <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/>
                        </svg>
                    </button>
                    <button type="button" class="btn-icon btn-icon-danger" onclick="removeVariant('${variantId}')" title="Remove Variant">×</button>
                </div>
            </div>
            
            <div class="variant-form">
                <div class="form-grid form-grid-cols-2">
                    <div class="form-group">
                        <label class="form-label required">Color</label>
                        <select name="new_variant_color_${variantId}" class="form-select" required onchange="updateVariantSKU('${variantId}')">
                            <option value="">Select a color...</option>
                            {% for color in colors %}
                            <option value="{{ color.id }}">{{ color.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Variant SKU</label>
                        <input 
                            type="text" 
                            name="new_variant_sku_${variantId}" 
                            id="variant_sku_${variantId}"
                            class="form-input"
                            readonly
                            style="background: var(--gray-50);"
                            placeholder="Auto-generated">
                    </div>
                </div>
                
                <!-- Picture Miniatures with Actions -->
                <div class="form-group">
                    <div class="pictures-section-header">
                        <label class="form-label">Pictures (0)</label>
                        <button type="button" class="btn btn-outline btn-sm" onclick="addVariantPicture('${variantId}')">
                            <svg style="width: 14px; height: 14px;" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                            </svg>
                            Add Picture
                        </button>
                    </div>
                    <div class="picture-miniatures" id="miniatures_display_${variantId}">
                        <div class="no-pictures" onclick="addVariantPicture('${variantId}')">
                            <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                                <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/>
                            </svg>
                            <span>Click to add pictures</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="variant-pictures" id="variant_pictures_${variantId}" style="display: none;">
                <div class="pictures-header">
                    <h5>Pictures for New Variant</h5>
                    <button type="button" class="btn btn-outline btn-sm" onclick="addVariantPicture('${variantId}')">
                        Add Picture
                    </button>
                </div>
                
                <div class="image-upload-area" id="upload_area_${variantId}">
                    <input type="file" id="variant_images_${variantId}" multiple accept="image/*" style="display: none;" onchange="handleVariantImages('${variantId}', this.files)">
                    <div class="upload-drop-zone" onclick="document.getElementById('variant_images_${variantId}').click()">
                        <svg class="upload-icon" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8.5 11.5a.5.5 0 0 1-1 0V7.707L6.354 8.854a.5.5 0 1 1-.708-.708l2-2a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 7.707V11.5z"/>
                            <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
                        </svg>
                        <p>Drop images or click to upload</p>
                    </div>
                </div>
                
                <div class="variant-pictures-grid" id="pictures_grid_${variantId}"></div>
            </div>
        `;
        
        container.appendChild(variantCard);
    }
    
    function removeVariant(variantId) {
        if (confirm('Are you sure you want to remove this variant and all its pictures?')) {
            const card = document.querySelector(`[data-variant-id="${variantId}"]`);
            if (card) {
                card.remove();
                
                // Show empty state if no variants left
                const container = document.getElementById('variants_container');
                if (container.children.length === 0) {
                    const emptyState = document.getElementById('empty_variants');
                    if (emptyState) {
                        emptyState.style.display = 'block';
                    }
                }
            }
        }
    }
    
    function toggleVariantPictures(variantId) {
        const picturesSection = document.getElementById(`variant_pictures_${variantId}`);
        if (picturesSection) {
            const isVisible = picturesSection.style.display !== 'none';
            picturesSection.style.display = isVisible ? 'none' : 'block';
        }
    }
    
    function updateVariantSKU(variantId) {
        var colorSelect = document.querySelector('[name*="variant_color_' + variantId + '"]');
        var skuInput = document.getElementById('variant_sku_' + variantId);
        var titleElement = document.querySelector('[data-variant-id="' + variantId + '"] .variant-title');
        var productNumber = document.getElementById('product_number').value;
        var supplierSelect = document.getElementById('supplier_id');
        var skuHelp = document.getElementById('sku_help_' + variantId);
        var skuPreview = document.getElementById('sku_preview_' + variantId);
        
        if (colorSelect && colorSelect.value && skuInput && productNumber) {
            var selectedOption = colorSelect.options[colorSelect.selectedIndex];
            var colorName = selectedOption.text;
            var supplierCode = supplierSelect ? supplierSelect.options[supplierSelect.selectedIndex].text : '';
            
            // Generate preview SKU matching database format
            var normalizedProductNumber = productNumber.toLowerCase().replace(/\s+/g, '_');
            var normalizedColorName = colorName.toLowerCase().replace(/\s+/g, '_');
            var previewSku = supplierCode ? 
                supplierCode.toLowerCase() + '_' + normalizedProductNumber + '_' + normalizedColorName :
                normalizedProductNumber + '_' + normalizedColorName;
            
            // Store original SKU if not already stored
            if (!skuInput.dataset.originalSku) {
                skuInput.dataset.originalSku = skuInput.value;
            }
            
            // If color changed, show preview
            if (colorSelect.value !== skuInput.dataset.originalColorId) {
                skuInput.value = previewSku;
                skuInput.style.color = 'var(--warning-color)';
                skuHelp.style.display = 'none';
                skuPreview.style.display = 'inline';
            } else {
                // Reset to original SKU
                skuInput.value = skuInput.dataset.originalSku;
                skuInput.style.color = '';
                skuHelp.style.display = 'inline';
                skuPreview.style.display = 'none';
            }
            
            // Update title
            if (titleElement) {
                titleElement.textContent = colorName + ' - ' + skuInput.value;
            }
            
            // Store current color ID for comparison
            skuInput.dataset.originalColorId = colorSelect.value;
        }
    }
    
    function handleVariantImages(variantId, files) {
        Array.from(files).forEach(file => {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    addVariantPictureToGrid(variantId, {
                        id: Date.now() + Math.random(),
                        file: file,
                        name: file.name,
                        url: e.target.result,
                        isNew: true
                    });
                };
                reader.readAsDataURL(file);
            }
        });
    }
    
    function addVariantPictureToGrid(variantId, picture) {
        const grid = document.getElementById(`pictures_grid_${variantId}`);
        if (!grid) return;
        
        // Calculate the next order number
        const existingPictures = grid.querySelectorAll('.picture-item[data-picture-id]:not([data-picture-id^="new_"])');
        const newPictures = grid.querySelectorAll('.picture-item[data-picture-id^="new_"]');
        const nextOrder = existingPictures.length + newPictures.length + 1;
        
        // Generate proper filename convention
        const productNumber = document.getElementById('product_number').value;
        const supplierSelect = document.getElementById('supplier_id');
        const colorSelect = document.querySelector(`[name*="variant_color_${variantId}"]`);
        
        let filename = '';
        if (productNumber && colorSelect && colorSelect.value) {
            const supplierCode = supplierSelect ? supplierSelect.options[supplierSelect.selectedIndex].text : '';
            const colorName = colorSelect.options[colorSelect.selectedIndex].text;
            
            const normalizedProductNumber = productNumber.toLowerCase().replace(/\s+/g, '_');
            const normalizedColorName = colorName.toLowerCase().replace(/\s+/g, '_');
            
            filename = supplierCode ? 
                `${supplierCode.toLowerCase()}_${normalizedProductNumber}_${normalizedColorName}_${nextOrder}` :
                `${normalizedProductNumber}_${normalizedColorName}_${nextOrder}`;
        } else {
            filename = `new_picture_${nextOrder}`;
        }
        
        // Create a new picture div (do not clear grid)
        const pictureDiv = document.createElement('div');
        pictureDiv.className = 'picture-item';
        pictureDiv.dataset.pictureId = picture.id || `new_${Date.now()}_${Math.random()}`;
        pictureDiv.dataset.order = nextOrder;
        
        pictureDiv.innerHTML = `
            <img src="${picture.url}" alt="${picture.name}">
            <div class="picture-overlay">
                <button type="button" class="btn-icon btn-icon-danger" onclick="removeVariantPicture('${variantId}', '${pictureDiv.dataset.pictureId}')">×</button>
                <button type="button" class="btn-icon btn-icon-primary" onclick="setPrimaryVariantPicture('${variantId}', '${pictureDiv.dataset.pictureId}')">★</button>
            </div>
            <div class="picture-info">
                <input type="text" 
                       name="new_picture_alt_${pictureDiv.dataset.pictureId}" 
                       value="${filename}"
                       placeholder="Alt text"
                       class="picture-alt-input">
                <small>Order: ${nextOrder} - New picture</small>
            </div>
        `;
        
        grid.appendChild(pictureDiv);
        
        // Store file data for form submission
        if (picture.file) {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'file';
            hiddenInput.name = `variant_${variantId}_images`;
            hiddenInput.style.display = 'none';
            
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(picture.file);
            hiddenInput.files = dataTransfer.files;
            
            pictureDiv.appendChild(hiddenInput);
        }
        
        // Update miniatures (will now show all pictures, not just the last one)
        updateVariantMiniatures(variantId);
    }
    
    function updateVariantMiniatures(variantId) {
        const miniatureContainer = document.getElementById(`miniatures_display_${variantId}`);
        const grid = document.getElementById(`pictures_grid_${variantId}`);
        
        if (!miniatureContainer) return;
        
        // Clear current miniatures
        miniatureContainer.innerHTML = '';
        
        // Collect all pictures: existing from database + new from grid
        let allPictures = [];
        
        // Get existing pictures from the database (these have numeric IDs and are rendered in HTML)
        const existingPicturesFromDB = document.querySelectorAll(`#pictures_grid_${variantId} .picture-item[data-picture-id]:not([data-picture-id^="new_"])`);
        existingPicturesFromDB.forEach(pictureItem => {
            const img = pictureItem.querySelector('img');
            const isPrimary = pictureItem.querySelector('.primary-badge');
            const pictureId = pictureItem.dataset.pictureId;
            
            if (img && pictureId && !pictureId.startsWith('new_')) {
                allPictures.push({
                    id: pictureId,
                    src: img.src,
                    alt: img.alt,
                    isPrimary: !!isPrimary,
                    isExisting: true
                });
            }
        });
        
        // Get new pictures that were just added (these have IDs starting with "new_")
        const newPicturesFromGrid = document.querySelectorAll(`#pictures_grid_${variantId} .picture-item[data-picture-id^="new_"]`);
        newPicturesFromGrid.forEach((pictureItem, index) => {
            const img = pictureItem.querySelector('img');
            const isPrimary = pictureItem.querySelector('.primary-badge');
            const pictureId = pictureItem.dataset.pictureId;
            
            if (img && pictureId) {
                allPictures.push({
                    id: pictureId,
                    src: img.src,
                    alt: img.alt,
                    isPrimary: !!isPrimary,
                    isExisting: false
                });
            }
        });
        
        const pictureCount = allPictures.length;
        
        // Update picture count in label
        const label = miniatureContainer.closest('.form-group').querySelector('.form-label');
        if (label) {
            label.textContent = `Pictures (${pictureCount})`;
        }
        
        if (pictureCount === 0) {
            miniatureContainer.innerHTML = `
                <div class="no-pictures" onclick="toggleVariantPictures(${variantId})">
                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                        <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/>
                    </svg>
                    <span>Click to add pictures</span>
                </div>
            `;
        } else {
            allPictures.forEach((picture, index) => {
                const miniature = document.createElement('div');
                miniature.className = 'miniature-item';
                miniature.dataset.pictureId = picture.id;
                miniature.title = `Order: ${index + 1}${picture.isPrimary ? ' - Primary' : ''}`;
                
                miniature.innerHTML = `
                    <img src="${picture.src}" alt="${picture.alt}" class="miniature-img">
                    <div class="miniature-actions">
                        <button type="button" class="miniature-action-btn delete" onclick="removeVariantPicture('${variantId}', '${picture.id}')" title="Remove">×</button>
                        ${picture.isPrimary ? 
                            '<span class="miniature-action-btn primary" title="Primary">★</span>' : 
                            '<button type="button" class="miniature-action-btn" onclick="setPrimaryVariantPicture(\'' + variantId + '\', \'' + picture.id + '\')" title="Set as primary">☆</button>'
                        }
                    </div>
                `;
                
                miniatureContainer.appendChild(miniature);
            });
        }
    }
    
    function addVariantPicture(variantId) {
        // Trigger file input for this variant
        const fileInput = document.getElementById(`variant_images_${variantId}`);
        if (fileInput) {
            fileInput.click();
        }
    }
    
    function editVariantPicture(variantId, pictureId) {
        // Show the detailed picture management section
        toggleVariantPictures(variantId);
    }
    
    function deleteVariantPicture(variantId, pictureId) {
        if (confirm('Are you sure you want to delete this picture?')) {
            // For existing pictures, mark for deletion
            const pictureItem = document.querySelector(`[data-picture-id="${pictureId}"]`);
            if (pictureItem) {
                // Add hidden input to mark for deletion
                const deleteInput = document.createElement('input');
                deleteInput.type = 'hidden';
                deleteInput.name = 'delete_pictures';
                deleteInput.value = pictureId;
                document.getElementById('component_form').appendChild(deleteInput);
                
                // Remove from grid
                pictureItem.remove();
                
                // Update miniatures
                updateVariantMiniatures(variantId);
            }
        }
    }
    
    function removeVariantPicture(variantId, pictureId) {
        // Find the picture item in the grid
        const grid = document.getElementById(`pictures_grid_${variantId}`);
        if (!grid) return;
        
        const pictureItem = grid.querySelector(`[data-picture-id="${pictureId}"]`);
        if (!pictureItem) return;
        
        if (confirm('Remove this picture?')) {
            // Remove from grid
            pictureItem.remove();
            
            // Update miniatures
            updateVariantMiniatures(variantId);
        }
    }
    
    function setPrimaryVariantPicture(variantId, pictureId) {
        // Remove primary status from all pictures in this variant
        const grid = document.getElementById(`pictures_grid_${variantId}`);
        if (grid) {
            grid.querySelectorAll('.primary-badge').forEach(badge => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn-icon btn-icon-primary';
                btn.onclick = () => setPrimaryVariantPicture(variantId, badge.closest('.picture-item').dataset.pictureId);
                btn.innerHTML = '★';
                badge.parentNode.replaceChild(btn, badge);
            });
            
            // Set new primary
            const newPrimary = grid.querySelector(`[data-picture-id="${pictureId}"] .btn-icon-primary`);
            if (newPrimary) {
                const badge = document.createElement('span');
                badge.className = 'primary-badge';
                badge.textContent = 'Primary';
                newPrimary.parentNode.replaceChild(badge, newPrimary);
            }
            
            // Update miniatures to reflect primary status
            updateVariantMiniatures(variantId);
        }
    }

    // Global functions for onclick handlers
    window.addNewVariant = addNewVariant;
    window.removeVariant = removeVariant;
    window.toggleVariantPictures = toggleVariantPictures;
    window.updateVariantSKU = updateVariantSKU;
    window.handleVariantImages = handleVariantImages;
    window.removeVariantPicture = removeVariantPicture;
    window.setPrimaryVariantPicture = setPrimaryVariantPicture;
    window.updateVariantMiniatures = updateVariantMiniatures;
    window.addVariantPicture = addVariantPicture;
    window.editVariantPicture = editVariantPicture;
    window.deleteVariantPicture = deleteVariantPicture;
    
    // Add event listener for the add variant button
    document.getElementById('add_variant_btn').addEventListener('click', addNewVariant);
});
</script>
{% endblock %}