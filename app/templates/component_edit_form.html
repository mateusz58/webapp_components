{% extends "base.html" %}

{% block title %}{{ 'Edit Component' if component else 'New Component' }} - ComponentHub{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/component_edit_form.css') }}">
{% endblock %}

{% block content %}
<!-- Success Notification Banner (positioned at top) -->
{% if changed_fields %}
<div class="success-notification-banner">
    <div class="success-notification-content">
        <div class="success-notification-header">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
            </svg>
            <strong>Component updated successfully!</strong>
        </div>
        <div class="success-notification-details">
            <strong>Updated fields:</strong>
            <span class="updated-fields">
                {% for field in changed_fields %}
                    {% if field == 'product_number' %}Product Number
                    {% elif field == 'description' %}Description
                    {% elif field == 'component_type_id' %}Component Type
                    {% elif field == 'supplier_id' %}Supplier
                    {% elif field == 'category_ids' or field == 'categories' %}Categories
                    {% elif field == 'keywords' %}Keywords
                    {% elif field == 'brands' %}Brands
                    {% elif field == 'properties' %}Properties
                    {% elif field == 'images' %}Images
                    {% else %}{{ field|title }}{% endif %}{% if not loop.last %}, {% endif %}
                {% endfor %}
            </span>
        </div>
    </div>
</div>
{% endif %}

<div class="component-form-layout">

    <!-- Main Form Column -->
    <div class="main-form">
        <!-- Page Header -->
        <div class="page-header">
            <h1>{{ 'Edit Component' if component else 'Create New Component' }}</h1>
            <p>{{ 'Update component details and properties' if component else 'Add a new component to your library' }}</p>
            <div class="header-actions">
                <a href="{{ url_for('component_web.index') }}" class="btn btn-secondary">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                    </svg>
                    Back to Components
                </a>
            </div>
        </div>

        <!-- Validation Summary -->
        <div id="validationSummary" class="validation-summary hidden">
            <h4 style="margin: 0 0 0.5rem 0; color: var(--danger-color); font-size: 1rem;">Please fix the following errors:</h4>
            <ul id="validationList" style="margin: 0; padding-left: 1.25rem;"></ul>
        </div>

        <!-- Main Form -->
        <form id="componentForm" method="POST" enctype="multipart/form-data" novalidate>
            
            <!-- Essential Information Section -->
            {% include 'sections/essential_information.html' %}
            
            <!-- Keywords Section -->
            {% include 'sections/keywords.html' %}
            
            <!-- Component Variants Section -->
            {% include 'sections/component_variants.html' %}
            
            <!-- Component Properties Section -->
            {% include 'sections/component_properties.html' %}

            <!-- Submit Button -->
            <div class="form-actions">
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855H.766l-.452.18a.5.5 0 0 0-.082.887l.41.26.001.002 4.995 3.178 3.178 4.995.002.002.26.41a.5.5 0 0 0 .886-.083l6-15Zm-1.833 1.89L6.637 10.07l-.215-.338a.5.5 0 0 0-.154-.154l-.338-.215 7.494-7.494 1.178-.471-.47 1.178Z"/>
                    </svg>
                    {{ 'Update Component' if component else 'Create Component' }}
                </button>
                <button type="button" class="btn btn-secondary" onclick="history.back()">
                    Cancel
                </button>
            </div>
        </form>

    </div>

    <!-- Sidebar -->
    <div class="form-sidebar">
        <div class="sidebar-card">
            <h3>Quick Reference</h3>
            <ul class="reference-list">
                <li><strong>Product Number:</strong> Unique identifier for this component</li>
                <li><strong>Component Type:</strong> Determines available properties</li>
                <li><strong>Categories:</strong> Organize components for easy filtering</li>
                <li><strong>Brand/Subbrand:</strong> Associate with brands and subbrands</li>
                <li><strong>Keywords:</strong> Help with search and categorization</li>
                <li><strong>Variants:</strong> Different color options with pictures</li>
            </ul>
        </div>

        {% if component %}
        <div class="sidebar-card">
            <h3>Component Info</h3>
            <div class="info-grid">
                <div class="info-item">
                    <label>Created</label>
                    <span>{{ component.created_at.strftime('%Y-%m-%d') if component.created_at else 'Unknown' }}</span>
                </div>
                <div class="info-item">
                    <label>Last Updated</label>
                    <span>{{ component.updated_at.strftime('%Y-%m-%d') if component.updated_at else 'Unknown' }}</span>
                </div>
                <div class="info-item">
                    <label>Variants</label>
                    <span>{{ component.variants|length }} colors</span>
                </div>
                <div class="info-item">
                    <label>Status</label>
                    <div class="status-grid">
                        <span class="status-badge status-{{ component.proto_status }}">{{ component.proto_status.title() }}</span>
                        <span class="status-badge status-{{ component.sms_status }}">{{ component.sms_status.title() }}</span>
                        <span class="status-badge status-{{ component.pps_status }}">{{ component.pps_status.title() }}</span>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('componentForm');
    const validationSummary = document.getElementById('validationSummary');
    const validationList = document.getElementById('validationList');
    const submitBtn = document.getElementById('submitBtn');
    const propertiesContainer = document.getElementById('properties_container');
    
    let validationErrors = {};

    // Pass template data to JavaScript
    {% if colors %}
    window.availableColors = [
        {% for color in colors %}
        {
            "id": {{ color.id }},
            "name": "{{ color.name|e }}"
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    {% endif %}

    {% if component_types %}
    window.componentTypes = [
        {% for component_type in component_types %}
        {
            "id": {{ component_type.id }},
            "name": "{{ component_type.name|e }}"
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    {% endif %}

    // Form validation and submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (validateForm()) {
            {% if component %}
            // For editing, show change summary modal first
            if (typeof showChangeSummaryModal === 'function') {
                showChangeSummaryModal();
            } else {
                // Fallback: direct submission if modal function not available
                submitFormDirectly();
            }
            {% else %}
            // For new components, submit directly
            submitFormDirectly();
            {% endif %}
        }
    });
    
    function submitFormDirectly() {
        // Ensure variant files are properly attached before submission
        if (window.variantManager && typeof window.variantManager.updateFormFiles === 'function') {
            window.variantManager.updateFormFiles();
        }
        
        // Show loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<div class="spinner"></div> Saving...';
        
        // Submit form
        form.submit();
    }
    
    // Make submitFormDirectly available globally for modal
    window.submitFormDirectly = submitFormDirectly;

    // Real-time validation
    form.addEventListener('input', function(e) {
        if (e.target.classList.contains('form-input') || e.target.classList.contains('form-select')) {
            validateField(e.target);
        }
    });

    // Component type change handler
    const componentTypeSelect = document.getElementById('component_type_id');
    if (componentTypeSelect) {
        componentTypeSelect.addEventListener('change', function() {
            loadComponentTypeProperties(this.value);
        });
        
        // Load properties for initially selected type
        if (componentTypeSelect.value) {
            loadComponentTypeProperties(componentTypeSelect.value);
        }
    }

    function validateForm() {
        validationErrors = {};
        let isValid = true;

        // Clear previous validation
        document.querySelectorAll('.form-input, .form-select').forEach(field => {
            field.classList.remove('error');
        });
        document.querySelectorAll('.form-error').forEach(error => {
            error.classList.add('hidden');
        });

        // Validate required fields
        const requiredFields = form.querySelectorAll('[required]');
        requiredFields.forEach(field => {
            if (!validateField(field)) {
                isValid = false;
            }
        });

        updateValidationSummary();
        return isValid;
    }

    function validateField(field) {
        const fieldName = field.name;
        const errorElement = document.getElementById(fieldName + '_error');
        let isValid = true;
        let errorMessage = '';

        // Clear previous error
        field.classList.remove('error');
        if (errorElement) {
            errorElement.classList.add('hidden');
            delete validationErrors[fieldName];
        }

        // Field-specific validation
        switch (fieldName) {
            case 'product_number':
                if (!field.value.trim()) {
                    errorMessage = 'Product number is required';
                    isValid = false;
                } else if (field.value.trim().length < 3) {
                    errorMessage = 'Product number must be at least 3 characters';
                    isValid = false;
                }
                break;
            case 'component_type_id':
                if (!field.value) {
                    errorMessage = 'Component type is required';
                    isValid = false;
                }
                break;
        }

        if (!isValid && errorElement) {
            field.classList.add('error');
            errorElement.textContent = errorMessage;
            errorElement.classList.remove('hidden');
            validationErrors[fieldName] = errorMessage;
        }

        updateValidationSummary();
        return isValid;
    }

    function updateValidationSummary() {
        const errorCount = Object.keys(validationErrors).length;
        
        if (errorCount > 0) {
            validationList.innerHTML = '';
            Object.values(validationErrors).forEach(error => {
                const li = document.createElement('li');
                li.textContent = error;
                validationList.appendChild(li);
            });
            validationSummary.classList.remove('hidden');
        } else {
            validationSummary.classList.add('hidden');
        }
    }

    function loadComponentTypeProperties(componentTypeId) {
        if (!componentTypeId) {
            const noPropertiesDiv = document.getElementById('no_properties');
            if (noPropertiesDiv) {
                noPropertiesDiv.style.display = 'block';
            }
            propertiesContainer.innerHTML = '';
            return;
        }

        // Hide no properties message
        const noPropertiesDiv = document.getElementById('no_properties');
        if (noPropertiesDiv) {
            noPropertiesDiv.style.display = 'none';
        }

        // Show loading
        propertiesContainer.innerHTML = '<div class="text-center" style="padding: 2rem;"><div class="spinner" style="margin: 0 auto;"></div></div>';

        // Load properties via AJAX
        fetch(`/api/component-type/${componentTypeId}/properties`)
            .then(response => response.json())
            .then(properties => {
                renderProperties(properties);
            })
            .catch(() => {
                renderProperties([]);
            });
    }

    function renderProperties(properties) {
        if (properties.length === 0) {
            propertiesContainer.innerHTML = '<div class="text-center" style="padding: 2rem; color: var(--gray-500);"><p>No specific properties for this component type</p></div>';
            return;
        }

        propertiesContainer.innerHTML = '';
        const propertyGrid = document.createElement('div');
        propertyGrid.className = 'properties-grid';
        
        properties.forEach(property => {
            const propertyDiv = createPropertyField(property);
            propertyGrid.appendChild(propertyDiv);
        });
        
        propertiesContainer.appendChild(propertyGrid);
    }

    function createPropertyField(property) {
        const div = document.createElement('div');
        div.className = 'form-group';

        const label = document.createElement('label');
        label.className = 'form-label' + (property.is_required ? ' required' : '');
        label.textContent = property.display_name || property.property_name;
        label.setAttribute('for', property.property_name);

        let input;
        switch (property.property_type) {
            case 'text':
                input = document.createElement('input');
                input.type = 'text';
                input.className = 'form-input';
                break;
            case 'number':
                input = document.createElement('input');
                input.type = 'number';
                input.className = 'form-input';
                break;
            case 'select':
                input = document.createElement('select');
                input.className = 'form-select';
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Select...';
                input.appendChild(defaultOption);
                
                if (property.options && Array.isArray(property.options)) {
                    property.options.forEach(option => {
                        const optionElement = document.createElement('option');
                        optionElement.value = option;
                        optionElement.textContent = option;
                        input.appendChild(optionElement);
                    });
                }
                break;
            case 'textarea':
                input = document.createElement('textarea');
                input.className = 'form-textarea';
                input.rows = 3;
                break;
            default:
                input = document.createElement('input');
                input.type = 'text';
                input.className = 'form-input';
        }

        input.name = `property_${property.property_name}`;
        input.id = property.property_name;
        if (property.is_required) {
            input.required = true;
        }

        // Set existing value if editing
        {% if component and component.properties %}
        const existingValue = {{ component.properties|tojson }};
        if (existingValue && existingValue[`property_${property.property_name}`]) {
            const value = existingValue[`property_${property.property_name}`];
            input.value = typeof value === 'object' && value.value ? value.value : value;
        }
        {% endif %}

        div.appendChild(label);
        div.appendChild(input);

        return div;
    }

    // Global picture preview function
    function previewPicture(imageUrl, imageName, pictureId) {
        let modal = document.getElementById('picturePreviewModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'picturePreviewModal';
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="picturePreviewTitle">Picture Preview</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <img id="picturePreviewImage" src="" alt="" class="img-fluid" style="max-height: 70vh;">
                            <div class="mt-3">
                                <strong>Filename:</strong> <span id="picturePreviewFilename"></span>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Set image and filename
        document.getElementById('picturePreviewImage').src = imageUrl;
        document.getElementById('picturePreviewImage').alt = imageName;
        document.getElementById('picturePreviewFilename').textContent = imageName;
        document.getElementById('picturePreviewTitle').textContent = `Picture Preview - ${imageName}`;
        
        // Show modal
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
    }
    
    // Add to global scope
    window.previewPicture = previewPicture;

});
</script>

<!-- Keyword Autocomplete Module -->
<script src="{{ url_for('static', filename='js/keyword_autocomplete.js') }}?v={{ cache_bust_version }}"></script>

<!-- Category Selector Module -->
<script src="{{ url_for('static', filename='js/category_selector.js') }}?v={{ cache_bust_version }}"></script>

<!-- Variant Manager Module -->
<script src="{{ url_for('static', filename='js/modules/variant_manager.js') }}?v={{ cache_bust_version }}"></script>

<!-- Brand Manager Module -->
<script src="{{ url_for('static', filename='js/modules/brand_manager.js') }}?v={{ cache_bust_version }}"></script>

<!-- Include Change Summary Modal (only for edit mode) -->
{% if component %}
{% include 'modals/change_summary_modal.html' %}
{% endif %}

{% endblock %}