{% extends "base.html" %}

{% block title %}Component: {{ component.product_number }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Component Details</h1>
    <div>
        <a href="{{ url_for('main.edit_component', id=component.id) }}" class="btn btn-warning">Edit</a>
        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">Delete</button>
        <a href="{{ url_for('main.index') }}" class="btn btn-secondary">Back to List</a>
    </div>
</div>

<!-- Component Info Card -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Basic Information</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <table class="table">
                    <tr>
                        <th style="width: 30%">Product Number:</th>
                        <td><strong>{{ component.product_number }}</strong></td>
                    </tr>
                    <tr>
                        <th>Component Type:</th>
                        <td><span class="badge bg-primary fs-6">{{ component.component_type.name }}</span></td>
                    </tr>
                    <tr>
                        <th>Supplier:</th>
                        <td>{{ component.supplier.supplier_code }}</td>
                    </tr>
                    <tr>
                        <th>Category:</th>
                        <td>{{ component.category.name }}</td>
                    </tr>
                    <tr>
                        <th>Created:</th>
                        <td>{{ component.created_at.strftime('%Y-%m-%d %H:%M') if component.created_at else '-' }}</td>
                    </tr>
                    <tr>
                        <th>Updated:</th>
                        <td>{{ component.updated_at.strftime('%Y-%m-%d %H:%M') if component.updated_at else '-' }}</td>
                    </tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Description:</h6>
                <p>{{ component.description if component.description else '<em>No description provided</em>' | safe }}</p>
                
                <h6>Keywords:</h6>
                <div class="mb-3">
                    {% if component.keywords %}
                        {% for keyword in component.keywords %}
                            <span class="badge bg-secondary me-1 mb-1">{{ keyword.name }}</span>
                        {% endfor %}
                    {% else %}
                        <span class="text-muted">No keywords</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Type-Specific Properties Card -->
{% if component.properties %}
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">{{ component.component_type.name }} Properties</h5>
    </div>
    <div class="card-body">
        <div class="row">
            {% for key, prop in component.properties.items() %}
                <div class="col-md-6 mb-3">
                    <div class="border rounded p-3 h-100">
                        <h6 class="text-primary mb-2">{{ key|title }}</h6>
                        <div class="mb-2">
                            {% if prop.value is iterable and prop.value is not string %}
                                {% for value in prop.value %}
                                    <span class="badge bg-info me-1">{{ value }}</span>
                                {% endfor %}
                            {% else %}
                                <strong>{{ prop.value }}</strong>
                            {% endif %}
                        </div>
                        <small class="text-muted">
                            Type: {{ prop.type|default('text') }}
                            {% if prop.updated_at %}
                                | Updated: {{ prop.updated_at[:19] }}
                            {% endif %}
                        </small>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>
{% else %}
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">{{ component.component_type.name }} Properties</h5>
    </div>
    <div class="card-body">
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            No type-specific properties defined for this component.
        </div>
    </div>
</div>
{% endif %}

<!-- Pictures Card -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Pictures</h5>
    </div>
    <div class="card-body">
        {% if component.pictures %}
            <div class="row">
                {% for picture in component.pictures|sort(attribute='picture_order') %}
                    <div class="col-md-4 col-lg-3 mb-3">
                        <div class="card">
                            <img src="{{ picture.url }}" class="card-img-top" alt="{{ picture.picture_name }}" style="height: 200px; object-fit: cover;">
                            <div class="card-body">
                                <h6 class="card-title">{{ picture.picture_name }}</h6>
                                <p class="card-text">
                                    <small class="text-muted">Order: {{ picture.picture_order }}</small>
                                </p>
                                <a href="{{ picture.url }}" target="_blank" class="btn btn-sm btn-outline-primary">View Full Size</a>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="alert alert-info">
                <i class="fas fa-images"></i>
                No pictures available for this component.
            </div>
        {% endif %}
    </div>
</div>

<!-- Component JSON Data (for debugging/advanced users) -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <button class="btn btn-link text-decoration-none p-0" type="button" data-bs-toggle="collapse" data-bs-target="#jsonData">
                <i class="fas fa-code"></i> Raw Data (JSON)
            </button>
        </h5>
    </div>
    <div class="collapse" id="jsonData">
        <div class="card-body">
            <h6>Properties JSON:</h6>
            <pre class="bg-light p-3 rounded"><code>{{ component.properties | tojson(indent=2) if component.properties else '{}' }}</code></pre>
            
            <h6 class="mt-3">Keywords:</h6>
            <pre class="bg-light p-3 rounded"><code>{{ component.keywords | map(attribute='name') | list | tojson(indent=2) }}</code></pre>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Warning!</strong> This action cannot be undone.
                </div>
                <p>Are you sure you want to delete component <strong>{{ component.product_number }}</strong>?</p>
                <p>This will also delete:</p>
                <ul>
                    <li>{{ component.pictures|length }} picture(s)</li>
                    <li>All property data</li>
                    <li>Keyword associations</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="{{ url_for('main.delete_component', id=component.id) }}" method="POST" class="d-inline">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Delete Component
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Image loading error handling
document.addEventListener('DOMContentLoaded', function() {
    const images = document.querySelectorAll('img[src]');
    images.forEach(img => {
        img.addEventListener('error', function() {
            this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlIE5vdCBGb3VuZDwvdGV4dD48L3N2Zz4=';
            this.alt = 'Image not found';
        });
    });
});
</script>
{% endblock %}
