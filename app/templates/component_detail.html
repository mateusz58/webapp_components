{% extends "base.html" %}

{% block title %}{{ component.product_number }} - Component Details{% endblock %}

{% block extra_css %}
<style>
    .component-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: var(--border-radius-lg);
        padding: 2rem;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
    }

    .component-header::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 200px;
        height: 200px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        transform: translate(50px, -50px);
    }

    .component-header .content {
        position: relative;
        z-index: 2;
    }

    /* IMPROVED COMPACT SQUARE IMAGE CONTAINER */
    .variant-gallery {
        background: white;
        border-radius: var(--border-radius-lg);
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-md);
    }

    .variant-selector {
        background: #f8fafc;
        border-radius: var(--border-radius);
        padding: 1rem;
        margin-bottom: 1.5rem;
        border: 1px solid #e2e8f0;
    }

    .variant-option {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        border-radius: var(--border-radius);
        cursor: pointer;
        transition: all 0.2s ease;
        margin-bottom: 0.5rem;
        border: 2px solid transparent;
    }

    .variant-option:hover {
        background: white;
        box-shadow: var(--shadow-sm);
    }

    .variant-option.active {
        background: white;
        border-color: var(--color-primary);
        box-shadow: var(--shadow-md);
    }

    .variant-color-swatch {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-right: 1rem;
        flex-shrink: 0;
    }

    .main-image-container {
        position: relative;
        margin-bottom: 1rem;
        border-radius: var(--border-radius-lg);
        overflow: hidden;
        background: #f8fafc;
        /* Make it square and compact */
        aspect-ratio: 1 / 1;
        max-width: 450px;
        margin-left: auto;
        margin-right: auto;
        border: 2px solid #e2e8f0;
        transition: all 0.3s ease;
    }

    .main-image-container:hover {
        border-color: var(--color-primary);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }

    .main-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: center;
        cursor: pointer;
        transition: all 0.4s ease;
        border-radius: var(--border-radius);
    }

    .main-image:hover {
        transform: scale(1.03);
    }

    .image-placeholder {
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        border-radius: var(--border-radius);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--color-secondary);
        border: 2px dashed #cbd5e1;
        transition: all 0.3s ease;
    }

    .image-placeholder:hover {
        border-color: var(--color-primary);
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }

    /* IMPROVED THUMBNAIL GALLERY */
    .thumbnail-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
        gap: 0.75rem;
        margin-top: 1.5rem;
        max-height: 140px;
        overflow-y: auto;
        padding: 1rem;
        background: #f8fafc;
        border-radius: var(--border-radius-lg);
        border: 1px solid #e2e8f0;
    }

    .thumbnail {
        width: 100%;
        aspect-ratio: 1 / 1;
        object-fit: cover;
        object-position: center;
        border-radius: var(--border-radius);
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .thumbnail:hover {
        border-color: var(--color-primary);
        transform: scale(1.08);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 1;
        position: relative;
    }

    .thumbnail.active {
        border-color: var(--color-primary);
        transform: scale(1.05);
        box-shadow: 0 0 0 3px rgba(var(--color-primary-rgb), 0.2);
    }

    /* IMPROVED LIGHTBOX - More compact and user-friendly */
    .lightbox {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        padding: 2rem;
    }

    .lightbox.active {
        opacity: 1;
        visibility: visible;
    }

    .lightbox-content {
        max-width: 90vw;
        max-height: 90vh;
        object-fit: contain;
        border-radius: var(--border-radius-lg);
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
    }

    .lightbox-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: rgba(255, 255, 255, 0.9);
        border: none;
        color: #333;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 18px;
        font-weight: bold;
    }

    .lightbox-close:hover {
        background: white;
        transform: scale(1.1);
    }

    .lightbox-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(255, 255, 255, 0.9);
        border: none;
        color: #333;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .lightbox-nav:hover {
        background: white;
        transform: translateY(-50%) scale(1.1);
    }

    .lightbox-prev {
        left: 2rem;
    }

    .lightbox-next {
        right: 2rem;
    }

    .lightbox-info {
        position: absolute;
        bottom: 2rem;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 1rem 2rem;
        border-radius: 25px;
        font-size: 0.9rem;
        backdrop-filter: blur(10px);
        max-width: 400px;
        text-align: center;
    }

    /* Workflow styles remain the same */
    .status-workflow {
        background: white;
        border-radius: var(--border-radius-lg);
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-md);
    }

    .workflow-step {
        display: flex;
        align-items: center;
        padding: 1rem;
        margin-bottom: 0.5rem;
        border-radius: var(--border-radius);
        transition: all 0.3s ease;
        cursor: pointer;
        border: 2px solid transparent;
    }

    .workflow-step:hover {
        background: #f8fafc;
        transform: translateX(5px);
    }

    .workflow-step.pending {
        background: #fef3c7;
        border-color: #f59e0b;
    }

    .workflow-step.ok {
        background: #dcfce7;
        border-color: #10b981;
    }

    .workflow-step.not_ok {
        background: #fee2e2;
        border-color: #ef4444;
    }

    .workflow-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        flex-shrink: 0;
    }

    .workflow-step.pending .workflow-icon {
        background: #f59e0b;
        color: white;
    }

    .workflow-step.ok .workflow-icon {
        background: #10b981;
        color: white;
    }

    .workflow-step.not_ok .workflow-icon {
        background: #ef4444;
        color: white;
    }

    /* Info tabs */
    .info-tabs {
        background: white;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-md);
        overflow: hidden;
    }

    .nav-tabs-modern {
        background: #f8fafc;
        border: none;
        padding: 0.5rem;
    }

    .nav-tabs-modern .nav-link {
        border: none;
        border-radius: var(--border-radius);
        color: var(--color-secondary);
        font-weight: 500;
        padding: 0.75rem 1.5rem;
        margin-right: 0.25rem;
        transition: all 0.2s ease;
    }

    .nav-tabs-modern .nav-link:hover {
        background: white;
        color: var(--color-primary);
    }

    .nav-tabs-modern .nav-link.active {
        background: var(--color-primary);
        color: white;
    }

    .tab-content-modern {
        padding: 2rem;
    }

    /* Action buttons */
    .action-buttons {
        position: sticky;
        top: 100px;
        background: white;
        border-radius: var(--border-radius-lg);
        padding: 1.5rem;
        box-shadow: var(--shadow-md);
    }

    /* Status update form */
    .status-update-form {
        background: #f8fafc;
        border-radius: var(--border-radius);
        padding: 1rem;
        margin-top: 1rem;
        display: none;
    }

    .status-update-form.show {
        display: block;
        animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* PROFESSIONAL VARIANT CHIPS */
    .variant-chips {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-top: 1rem;
        padding: 1rem;
        background: #f8fafc;
        border-radius: var(--border-radius-lg);
        border: 1px solid #e2e8f0;
    }

    .variant-chip {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1.25rem;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.875rem;
        font-weight: 500;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        min-height: 44px;
    }

    .variant-chip:hover {
        border-color: var(--color-primary);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .variant-chip.active {
        border-color: var(--color-primary);
        background: var(--color-primary);
        color: white;
        box-shadow: 0 4px 12px rgba(var(--color-primary-rgb), 0.3);
    }

    .variant-chip-color {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 2px solid rgba(255, 255, 255, 0.9);
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        flex-shrink: 0;
    }

    /* RESPONSIVE IMPROVEMENTS */
    @media (max-width: 768px) {
        .lightbox {
            padding: 1rem;
        }

        .lightbox-content {
            max-width: 95vw;
            max-height: 80vh;
        }

        .lightbox-nav {
            width: 40px;
            height: 40px;
        }

        .lightbox-prev {
            left: 1rem;
        }

        .lightbox-next {
            right: 1rem;
        }

        .main-image-container {
            max-width: 100%;
            aspect-ratio: 1 / 1;
        }

        .thumbnail-gallery {
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 0.5rem;
            padding: 0.75rem;
            max-height: 120px;
        }

        .variant-chips {
            gap: 0.5rem;
            padding: 0.75rem;
        }

        .variant-chip {
            padding: 0.5rem 1rem;
            gap: 0.5rem;
            font-size: 0.8rem;
            min-height: 40px;
        }

        .variant-chip-color {
            width: 20px;
            height: 20px;
        }
    }

    @media (max-width: 576px) {
        .main-image-container {
            margin-bottom: 1rem;
        }

        .variant-gallery {
            padding: 1rem;
        }

        .thumbnail-gallery {
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            max-height: 100px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div x-data="componentDetail()" class="fade-in">
    <!-- Component Header -->
    <div class="component-header">
        <div class="content">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="d-flex align-items-center mb-2">
                        <h1 class="h2 mb-0 me-3">{{ component.product_number }}</h1>
                        <span class="status-badge status-{{ component.get_overall_status() }}">
                            {% if component.get_overall_status() == 'approved' %}
                                <i data-lucide="check-circle" style="width: 16px; height: 16px;"></i>
                            {% elif component.get_overall_status() == 'rejected' %}
                                <i data-lucide="x-circle" style="width: 16px; height: 16px;"></i>
                            {% else %}
                                <i data-lucide="clock" style="width: 16px; height: 16px;"></i>
                            {% endif %}
                            {{ component.get_status_display() }}
                        </span>
                    </div>
                    <p class="mb-3 opacity-90">
                        {{ component.description if component.description else 'No description provided' }}
                    </p>
                    <div class="d-flex gap-3 flex-wrap">
                        <div class="d-flex align-items-center">
                            <i data-lucide="tag" class="me-2" style="width: 18px; height: 18px;"></i>
                            <span>{{ component.component_type.name }}</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <i data-lucide="truck" class="me-2" style="width: 18px; height: 18px;"></i>
                            <span>{{ component.supplier.supplier_code }}</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <i data-lucide="folder" class="me-2" style="width: 18px; height: 18px;"></i>
                            <span>{{ component.category.name }}</span>
                        </div>
                        {% if component.variants %}
                        <div class="d-flex align-items-center">
                            <i data-lucide="palette" class="me-2" style="width: 18px; height: 18px;"></i>
                            <span>{{ component.variants|length }} color variant{{ component.variants|length|pluralize }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('main.edit_component', id=component.id) }}"
                       class="btn btn-warning-modern btn-modern">
                        <i data-lucide="edit" class="me-2" style="width: 18px; height: 18px;"></i>
                        Edit
                    </a>
                    <button type="button"
                            class="btn btn-danger-modern btn-modern"
                            data-bs-toggle="modal"
                            data-bs-target="#deleteModal">
                        <i data-lucide="trash-2" class="me-2" style="width: 18px; height: 18px;"></i>
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Variant Gallery -->
            <div class="variant-gallery">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="h5 mb-0 fw-bold">
                        <i data-lucide="images" class="me-2" style="width: 20px; height: 20px;"></i>
                        Image Gallery
                    </h3>
                    {% if component.variants %}
                    <div class="d-flex align-items-center gap-2">
                        <span class="text-muted">Current:</span>
                        <span class="fw-bold" x-text="currentVariant?.name || 'Main Component'"></span>
                    </div>
                    {% endif %}
                </div>

                <!-- Improved Variant Selector with Chips -->
                {% if component.variants %}
                <div class="mb-3">
                    <h6 class="fw-bold mb-2">Color Variants</h6>
                    <div class="variant-chips">
                        <!-- Main Component Chip -->
                        <div class="variant-chip"
                             :class="{ 'active': selectedVariant === null }"
                             @click="selectVariant(null)">
                            <div class="variant-chip-color" style="background: linear-gradient(135deg, #e2e8f0, #cbd5e1);"></div>
                            <span>Main ({{ component.pictures|length }})</span>
                        </div>

                        <!-- Variant Chips -->
                        {% for variant in component.variants %}
                        <div class="variant-chip"
                             :class="{ 'active': selectedVariant === {{ variant.id }} }"
                             @click="selectVariant({{ variant.id }})">
                            <div class="variant-chip-color"
                                 style="background: {{ variant.color.hex_code or '#ccc' }}"></div>
                            <span>{{ variant.get_display_name() }} ({{ variant.variant_pictures|length }})</span>
                        </div>
                        {% endfor %}

                        <!-- Add New Variant -->
                        <a href="{{ url_for('main.new_variant', id=component.id) }}"
                           class="variant-chip" style="border-style: dashed;">
                            <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
                            <span>Add Variant</span>
                        </a>
                    </div>
                </div>
                {% endif %}

                <!-- Main Image Display -->
                <div class="main-image-container">
                    <div x-show="currentImages.length > 0">
                        <img :src="currentImages[currentImageIndex]?.url"
                             :alt="currentImages[currentImageIndex]?.name"
                             class="main-image"
                             @click="openLightbox(currentImageIndex)"
                             x-ref="mainImage">
                    </div>

                    <!-- No Images Placeholder -->
                    <div x-show="currentImages.length === 0" class="image-placeholder">
                        <div class="text-center">
                            <i data-lucide="image" style="width: 60px; height: 60px;"></i>
                            <p class="mt-3 text-muted mb-0">No images available</p>
                            <a href="{{ url_for('main.edit_component', id=component.id) }}"
                               class="btn btn-primary-modern btn-modern mt-3">
                                <i data-lucide="upload" class="me-2" style="width: 16px; height: 16px;"></i>
                                Add Images
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Thumbnail Gallery -->
                <div x-show="currentImages.length > 1" class="thumbnail-gallery">
                    <template x-for="(image, index) in currentImages" :key="image.id">
                        <img :src="image.url"
                             :alt="image.name"
                             class="thumbnail"
                             :class="{ 'active': currentImageIndex === index }"
                             @click="currentImageIndex = index">
                    </template>
                </div>
            </div>

            <!-- Status Workflow (keeping original structure) -->
            <div class="status-workflow">
                <h3 class="h5 mb-3 fw-bold">
                    <i data-lucide="workflow" class="me-2" style="width: 20px; height: 20px;"></i>
                    Approval Workflow
                </h3>

                <!-- Proto Status -->
                <div class="workflow-step {{ component.proto_status }}"
                     @click="toggleStatusForm('proto')"
                     :class="{ 'border-primary': activeStatusForm === 'proto' }">
                    <div class="workflow-icon">
                        {% if component.proto_status == 'ok' %}
                        <i data-lucide="check" style="width: 20px; height: 20px;"></i>
                        {% elif component.proto_status == 'not_ok' %}
                        <i data-lucide="x" style="width: 20px; height: 20px;"></i>
                        {% else %}
                        <i data-lucide="clock" style="width: 20px; height: 20px;"></i>
                        {% endif %}
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">Proto Review</h6>
                                <small class="text-muted">Initial prototype assessment</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-{{ 'success' if component.proto_status == 'ok' else ('danger' if component.proto_status == 'not_ok' else 'warning') }}">
                                    {{ component.proto_status|title }}
                                </span>
                                {% if component.proto_date %}
                                <div class="small text-muted">{{ component.proto_date.strftime('%Y-%m-%d') }}</div>
                                {% endif %}
                            </div>
                        </div>
                        {% if component.proto_comment %}
                        <div class="mt-2 p-2 bg-light rounded">
                            <small>{{ component.proto_comment }}</small>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Status Update Form -->
                <div class="status-update-form" :class="{ 'show': activeStatusForm === 'proto' }">
                    <form method="POST" action="{{ url_for('main.update_proto_status', id=component.id) }}">
                        <div class="row">
                            <div class="col-md-4">
                                <select name="status" class="form-select form-control-modern" required>
                                    <option value="pending" {% if component.proto_status == 'pending' %}selected{% endif %}>Pending</option>
                                    <option value="ok" {% if component.proto_status == 'ok' %}selected{% endif %}>Approved</option>
                                    <option value="not_ok" {% if component.proto_status == 'not_ok' %}selected{% endif %}>Rejected</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <input type="text" name="comment" class="form-control form-control-modern"
                                       placeholder="Add a comment..." value="{{ component.proto_comment or '' }}">
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-primary-modern btn-modern w-100">Update</button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- SMS Status -->
                <div class="workflow-step {{ component.sms_status }}"
                     @click="toggleStatusForm('sms')"
                     :class="{ 'border-primary': activeStatusForm === 'sms' }">
                    <div class="workflow-icon">
                        {% if component.sms_status == 'ok' %}
                        <i data-lucide="check" style="width: 20px; height: 20px;"></i>
                        {% elif component.sms_status == 'not_ok' %}
                        <i data-lucide="x" style="width: 20px; height: 20px;"></i>
                        {% else %}
                        <i data-lucide="clock" style="width: 20px; height: 20px;"></i>
                        {% endif %}
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">SMS Review</h6>
                                <small class="text-muted">Safety and material standards</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-{{ 'success' if component.sms_status == 'ok' else ('danger' if component.sms_status == 'not_ok' else 'warning') }}">
                                    {{ component.sms_status|title }}
                                </span>
                                {% if component.sms_date %}
                                <div class="small text-muted">{{ component.sms_date.strftime('%Y-%m-%d') }}</div>
                                {% endif %}
                            </div>
                        </div>
                        {% if component.sms_comment %}
                        <div class="mt-2 p-2 bg-light rounded">
                            <small>{{ component.sms_comment }}</small>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- SMS Status Update Form -->
                <div class="status-update-form" :class="{ 'show': activeStatusForm === 'sms' }">
                    <form method="POST" action="{{ url_for('main.update_sms_status', id=component.id) }}">
                        <div class="row">
                            <div class="col-md-4">
                                <select name="status" class="form-select form-control-modern" required>
                                    <option value="pending" {% if component.sms_status == 'pending' %}selected{% endif %}>Pending</option>
                                    <option value="ok" {% if component.sms_status == 'ok' %}selected{% endif %}>Approved</option>
                                    <option value="not_ok" {% if component.sms_status == 'not_ok' %}selected{% endif %}>Rejected</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <input type="text" name="comment" class="form-control form-control-modern"
                                       placeholder="Add a comment..." value="{{ component.sms_comment or '' }}">
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-primary-modern btn-modern w-100">Update</button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- PPS Status -->
                <div class="workflow-step {{ component.pps_status }}"
                     @click="toggleStatusForm('pps')"
                     :class="{ 'border-primary': activeStatusForm === 'pps' }">
                    <div class="workflow-icon">
                        {% if component.pps_status == 'ok' %}
                        <i data-lucide="check" style="width: 20px; height: 20px;"></i>
                        {% elif component.pps_status == 'not_ok' %}
                        <i data-lucide="x" style="width: 20px; height: 20px;"></i>
                        {% else %}
                        <i data-lucide="clock" style="width: 20px; height: 20px;"></i>
                        {% endif %}
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">PPS Review</h6>
                                <small class="text-muted">Production and packaging standards</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-{{ 'success' if component.pps_status == 'ok' else ('danger' if component.pps_status == 'not_ok' else 'warning') }}">
                                    {{ component.pps_status|title }}
                                </span>
                                {% if component.pps_date %}
                                <div class="small text-muted">{{ component.pps_date.strftime('%Y-%m-%d') }}</div>
                                {% endif %}
                            </div>
                        </div>
                        {% if component.pps_comment %}
                        <div class="mt-2 p-2 bg-light rounded">
                            <small>{{ component.pps_comment }}</small>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- PPS Status Update Form -->
                <div class="status-update-form" :class="{ 'show': activeStatusForm === 'pps' }">
                    <form method="POST" action="{{ url_for('main.update_pps_status', id=component.id) }}">
                        <div class="row">
                            <div class="col-md-4">
                                <select name="status" class="form-select form-control-modern" required>
                                    <option value="pending" {% if component.pps_status == 'pending' %}selected{% endif %}>Pending</option>
                                    <option value="ok" {% if component.pps_status == 'ok' %}selected{% endif %}>Approved</option>
                                    <option value="not_ok" {% if component.pps_status == 'not_ok' %}selected{% endif %}>Rejected</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <input type="text" name="comment" class="form-control form-control-modern"
                                       placeholder="Add a comment..." value="{{ component.pps_comment or '' }}">
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-primary-modern btn-modern w-100">Update</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Information Tabs (keeping original structure) -->
            <div class="info-tabs">
                <ul class="nav nav-tabs nav-tabs-modern" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#basic-info" type="button">
                            <i data-lucide="info" class="me-2" style="width: 16px; height: 16px;"></i>
                            Basic Info
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#properties" type="button">
                            <i data-lucide="settings" class="me-2" style="width: 16px; height: 16px;"></i>
                            Properties
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#keywords" type="button">
                            <i data-lucide="tag" class="me-2" style="width: 16px; height: 16px;"></i>
                            Keywords
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#variants" type="button">
                            <i data-lucide="palette" class="me-2" style="width: 16px; height: 16px;"></i>
                            Variants ({{ component.variants|length }})
                        </button>
                    </li>
                </ul>

                <div class="tab-content tab-content-modern">
                    <!-- Basic Info Tab -->
                    <div class="tab-pane fade show active" id="basic-info">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Product Number</label>
                                    <p class="text-muted">{{ component.product_number }}</p>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Component Type</label>
                                    <p class="text-muted">{{ component.component_type.name }}</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Supplier</label>
                                    <p class="text-muted">{{ component.supplier.supplier_code }}</p>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Category</label>
                                    <p class="text-muted">{{ component.category.name }}</p>
                                </div>
                            </div>
                        </div>

                        {% if component.description %}
                        <div class="mb-3">
                            <label class="form-label fw-bold">Description</label>
                            <p class="text-muted">{{ component.description }}</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Properties Tab -->
                    <div class="tab-pane fade" id="properties">
                        {% if component.properties %}
                        <div class="row">
                            {% for key, prop in component.properties.items() %}
                            <div class="col-md-6 mb-3">
                                <div class="p-3 bg-light rounded">
                                    <label class="form-label fw-bold">{{ key|title }}</label>
                                    {% if prop.value is iterable and prop.value is not string %}
                                    <div class="d-flex flex-wrap gap-1">
                                        {% for value in prop.value %}
                                        <span class="badge bg-primary">{{ value }}</span>
                                        {% endfor %}
                                    </div>
                                    {% else %}
                                    <p class="text-muted mb-0">{{ prop.value }}</p>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i data-lucide="settings" style="width: 48px; height: 48px; color: var(--color-secondary);"></i>
                            <p class="text-muted mt-3 mb-0">No properties defined</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Keywords Tab -->
                    <div class="tab-pane fade" id="keywords">
                        {% if component.keywords %}
                        <div class="d-flex flex-wrap gap-2">
                            {% for keyword in component.keywords %}
                            <span class="badge bg-primary px-3 py-2">{{ keyword.name }}</span>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i data-lucide="tag" style="width: 48px; height: 48px; color: var(--color-secondary);"></i>
                            <p class="text-muted mt-3 mb-0">No keywords assigned</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Variants Tab -->
                    <div class="tab-pane fade" id="variants">
                        {% if component.variants %}
                        <div class="row">
                            {% for variant in component.variants %}
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="variant-color-swatch me-3"
                                                 style="background: {{ variant.color.hex_code or '#ccc' }}"></div>
                                            <div>
                                                <h6 class="mb-0">{{ variant.get_display_name() }}</h6>
                                                <small class="text-muted">{{ variant.color.name }}</small>
                                            </div>
                                        </div>

                                        {% if variant.description %}
                                        <p class="text-muted small mb-2">{{ variant.description }}</p>
                                        {% endif %}

                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">
                                                {{ variant.variant_pictures|length }} image{{ 's' if variant.variant_pictures|length != 1 else '' }}
                                            </small>
                                            <a href="{{ url_for('main.edit_variant', component_id=component.id, variant_id=variant.id) }}"
                                               class="btn btn-sm btn-outline-primary">
                                                Edit
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i data-lucide="palette" style="width: 48px; height: 48px; color: var(--color-secondary);"></i>
                            <p class="text-muted mt-3 mb-0">No color variants yet</p>
                            <a href="{{ url_for('main.new_variant', id=component.id) }}"
                               class="btn btn-primary-modern btn-modern mt-3">
                                Add First Variant
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <div class="action-buttons">
                <h5 class="fw-bold mb-3">Quick Actions</h5>

                <div class="d-grid gap-2">
                    <a href="{{ url_for('main.edit_component', id=component.id) }}"
                       class="btn btn-primary-modern btn-modern">
                        <i data-lucide="edit" class="me-2" style="width: 18px; height: 18px;"></i>
                        Edit Component
                    </a>

                    <a href="{{ url_for('main.new_variant', id=component.id) }}"
                       class="btn btn-success-modern btn-modern">
                        <i data-lucide="palette" class="me-2" style="width: 18px; height: 18px;"></i>
                        Add Color Variant
                    </a>

                    <button class="btn btn-warning-modern btn-modern" @click="duplicateComponent()">
                        <i data-lucide="copy" class="me-2" style="width: 18px; height: 18px;"></i>
                        Duplicate
                    </button>

                    <hr>

                    <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary">
                        <i data-lucide="arrow-left" class="me-2" style="width: 18px; height: 18px;"></i>
                        Back to List
                    </a>
                </div>

                <!-- Quick Color Preview -->
                {% if component.variants %}
                <div class="mt-4">
                    <h6 class="fw-bold mb-3">Available Colors</h6>
                    <div class="d-flex flex-wrap gap-2">
                        {% for variant in component.variants %}
                        <div class="position-relative"
                             style="cursor: pointer;"
                             @click="selectVariant({{ variant.id }})"
                             title="{{ variant.get_display_name() }}">
                            <div style="width: 30px; height: 30px; background: {{ variant.color.hex_code or '#ccc' }}; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- IMPROVED Lightbox Modal -->
    <div class="lightbox" :class="{ 'active': lightboxOpen }" @click="closeLightbox()">
        <!-- Main Image -->
        <img :src="currentImages[lightboxIndex]?.url"
             :alt="currentImages[lightboxIndex]?.name"
             class="lightbox-content"
             @click.stop>

        <!-- Navigation Controls -->
        <template x-if="currentImages.length > 1">
            <div>
                <button class="lightbox-prev" @click.stop="previousImage()">
                    <i data-lucide="chevron-left" style="width: 24px; height: 24px;"></i>
                </button>
                <button class="lightbox-next" @click.stop="nextImage()">
                    <i data-lucide="chevron-right" style="width: 24px; height: 24px;"></i>
                </button>
            </div>
        </template>

        <!-- Close Button -->
        <button class="lightbox-close" @click="closeLightbox()">
            ×
        </button>

        <!-- Image Info -->
        <div class="lightbox-info">
            <div class="fw-bold" x-text="currentImages[lightboxIndex]?.name"></div>
            <div class="small opacity-75" x-text="`${lightboxIndex + 1} of ${currentImages.length}`"></div>
        </div>
    </div>

    <!-- Compact Delete Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title">Confirm Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center">
                        <i data-lucide="alert-triangle" class="text-warning mb-3" style="width: 48px; height: 48px;"></i>
                        <p>Delete component <strong>{{ component.product_number }}</strong>?</p>
                        <p class="text-muted small">This action cannot be undone.</p>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form action="{{ url_for('main.delete_component', id=component.id) }}" method="POST" class="d-inline">
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function componentDetail() {
        return {
            activeStatusForm: null,
            lightboxOpen: false,
            lightboxIndex: 0,
            selectedVariant: null,
            currentImageIndex: 0,

            // Component data from server
            componentImages: [
                {% for picture in component.pictures|sort(attribute='picture_order') %}
                    {
                        id: {{ picture.id }},
                        name: '{{ picture.picture_name }}',
                        url: '{{ picture.url }}',
                        order: {{ picture.picture_order }}
                    }{% if not loop.last %},{% endif %}
                {% endfor %}
            ],

            variants: [
                {% for variant in component.variants %}
                    {
                        id: {{ variant.id }},
                        name: '{{ variant.get_display_name() }}',
                        colorName: '{{ variant.color.name }}',
                        colorHex: '{{ variant.color.hex_code or "#ccc" }}',
                        description: '{{ variant.description or "" }}',
                        images: [
                            {% for picture in variant.variant_pictures|sort(attribute='picture_order') %}
                                {
                                    id: {{ picture.id }},
                                    name: '{{ picture.picture_name }}',
                                    url: '{{ picture.url }}',
                                    order: {{ picture.picture_order }}
                                }{% if not loop.last %},{% endif %}
                            {% endfor %}
                        ]
                    }{% if not loop.last %},{% endif %}
                {% endfor %}
            ],

            get currentImages() {
                if (this.selectedVariant === null) {
                    return this.componentImages;
                } else {
                    const variant = this.variants.find(v => v.id === this.selectedVariant);
                    return variant ? variant.images : [];
                }
            },

            get currentVariant() {
                if (this.selectedVariant === null) {
                    return { name: 'Main Component' };
                }
                return this.variants.find(v => v.id === this.selectedVariant);
            },

            init() {
                this.currentImageIndex = 0;

                // Keyboard navigation
                document.addEventListener('keydown', (e) => {
                    if (this.lightboxOpen) {
                        if (e.key === 'Escape') {
                            this.closeLightbox();
                        } else if (e.key === 'ArrowLeft') {
                            this.previousImage();
                        } else if (e.key === 'ArrowRight') {
                            this.nextImage();
                        }
                    }
                });
            },

            selectVariant(variantId) {
                this.selectedVariant = variantId;
                this.currentImageIndex = 0;
            },

            toggleStatusForm(formType) {
                this.activeStatusForm = this.activeStatusForm === formType ? null : formType;
            },

            openLightbox(imageIndex) {
                this.lightboxIndex = imageIndex;
                this.lightboxOpen = true;
                document.body.style.overflow = 'hidden';
            },

            closeLightbox() {
                this.lightboxOpen = false;
                document.body.style.overflow = 'auto';
            },

            nextImage() {
                if (this.currentImages.length > 0) {
                    this.lightboxIndex = (this.lightboxIndex + 1) % this.currentImages.length;
                }
            },

            previousImage() {
                if (this.currentImages.length > 0) {
                    this.lightboxIndex = this.lightboxIndex === 0 ? this.currentImages.length - 1 : this.lightboxIndex - 1;
                }
            },

            duplicateComponent() {
                if (confirm('Create a duplicate of this component?')) {
                    fetch(`/api/components/{{ component.id }}/duplicate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrf_token]')?.value
                        }
                    }).then(response => response.json())
                      .then(data => {
                          if (data.success) {
                              window.location.href = `/component/${data.new_id}`;
                          } else {
                              alert('Error creating duplicate: ' + data.error);
                          }
                      });
                }
            }
        }
    }

    // Initialize icons after page load
    document.addEventListener('DOMContentLoaded', function() {
        lucide.createIcons();
    });
</script>
{% endblock %}